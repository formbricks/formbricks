!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).formbricks=t()}(this,(function(){"use strict";var e=Object.defineProperty,t=(t,n,r)=>((t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r)(t,"symbol"!=typeof n?n+"":n,r);const n="formbricks-js",r="formbricks-js-website",i="formbricks-js-app",o="formbricks-app-container",s=class e{constructor(){t(this,"logLevel","error")}static getInstance(){return e.instance||(e.instance=new e),e.instance}configure(e){e&&void 0!==e.logLevel&&(this.logLevel=e.logLevel)}logger(e,t){if("debug"===t&&"debug"!==this.logLevel)return;const n=`ðŸ§± Formbricks - ${(new Date).toISOString()} [${t.toUpperCase()}] - ${e}`;"error"===t?console.error(n):console.log(n)}debug(e){this.logger(e,"debug")}error(e){this.logger(e,"error")}};t(s,"instance");let a=s;const u=e=>({ok:!0,value:e}),c=e=>({ok:!1,error:e});const l=e=>(...t)=>{try{return{ok:!0,value:e(...t)}}catch(n){return{ok:!1,error:n}}},f=a.getInstance(),d=class e{constructor(e){t(this,"handleError"),t(this,"customized",!1),e?(this.handleError=e,this.customized=!0):this.handleError=e=>a.getInstance().error(JSON.stringify(e))}static getInstance(){return e.instance||(e.instance=new e),e.instance}static init(t){this.initialized=!0,e.instance=new e(t)}printStatus(){f.debug("Custom error handler: "+(this.customized?"yes":"no"))}handle(e){console.warn("ðŸ§± Formbricks - Global error: ",e),this.handleError(e)}};t(d,"instance"),t(d,"initialized",!1);let h=d;const p=class e{constructor(){t(this,"config",null);const e=this.loadFromLocalStorage();e.ok&&(this.config=e.value)}static getInstance(){return e.instance||(e.instance=new e),e.instance}update(e){var t,n;e&&(this.config={...this.config,...e,status:{value:(null==(t=e.status)?void 0:t.value)||"success",expiresAt:(null==(n=e.status)?void 0:n.expiresAt)||null}},this.saveToStorage())}get(){if(!this.config)throw new Error("config is null, maybe the init function was not called?");return this.config}loadFromLocalStorage(){var e;if("undefined"!=typeof window){const t=localStorage.getItem(n);if(t){const n=JSON.parse(t);return(null==(e=n.environmentState)?void 0:e.expiresAt)&&new Date(n.environmentState.expiresAt)<=new Date?c(new Error("Config in local storage has expired")):u(n)}}return c(new Error("No or invalid config in local storage"))}async saveToStorage(){return l((async()=>{await localStorage.setItem(n,JSON.stringify(this.config))}))()}async resetConfig(){return this.config=null,l((async()=>{localStorage.removeItem(n)}))()}};t(p,"instance");let g=p;var y=Object.defineProperty,w=(e,t,n)=>((e,t,n)=>t in e?y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);const m=e=>({ok:!1,error:e}),v=async(e,t,n,r)=>{const i=new URL(e+t),o=r?JSON.stringify(r):void 0,s=await(a=fetch,async(...e)=>{try{return{ok:!0,data:await a(...e)}}catch(t){return{ok:!1,error:t}}})(i.toString(),{method:n,headers:{"Content-Type":"application/json"},body:o});var a;if(!s.ok)return m(s.error);const u=s.data,c=await u.json();if(!u.ok){const e=c;return m({code:"network_error",status:u.status,message:e.message||"Something went wrong",url:i,...Object.keys(e.details).length>0&&{details:e.details}})}return(e=>({ok:!0,data:e}))(c.data)};class b{constructor(e,t){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=e,this.environmentId=t}async update(e){const t={};for(const n in e.attributes)t[n]=String(e.attributes[n]);return v(this.apiHost,`/api/v1/client/${this.environmentId}/people/${e.userId}/attributes`,"PUT",{attributes:t})}}class I{constructor(e,t){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return v(this.apiHost,`/api/v1/client/${this.environmentId}/displays`,"POST",e)}}class S{constructor(e,t){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return v(this.apiHost,`/api/v1/client/${this.environmentId}/people`,"POST",{environmentId:this.environmentId,userId:e})}}class E{constructor(e,t){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return v(this.apiHost,`/api/v1/client/${this.environmentId}/responses`,"POST",e)}async update({responseId:e,finished:t,data:n,ttc:r,variables:i,language:o}){return v(this.apiHost,`/api/v1/client/${this.environmentId}/responses/${e}`,"PUT",{finished:t,data:n,ttc:r,variables:i,language:o})}}for(var k={},B={byteLength:function(e){var t=U(e),n=t[0],r=t[1];return 3*(n+r)/4-r},toByteArray:function(e){var t,n,r=U(e),i=r[0],o=r[1],s=new R(function(e,t,n){return 3*(t+n)/4-n}(0,i,o)),a=0,u=o>0?i-4:i;for(n=0;n<u;n+=4)t=C[e.charCodeAt(n)]<<18|C[e.charCodeAt(n+1)]<<12|C[e.charCodeAt(n+2)]<<6|C[e.charCodeAt(n+3)],s[a++]=t>>16&255,s[a++]=t>>8&255,s[a++]=255&t;2===o&&(t=C[e.charCodeAt(n)]<<2|C[e.charCodeAt(n+1)]>>4,s[a++]=255&t);1===o&&(t=C[e.charCodeAt(n)]<<10|C[e.charCodeAt(n+1)]<<4|C[e.charCodeAt(n+2)]>>2,s[a++]=t>>8&255,s[a++]=255&t);return s},fromByteArray:function(e){for(var t,n=e.length,r=n%3,i=[],o=16383,s=0,a=n-r;s<a;s+=o)i.push(L(e,s,s+o>a?a:s+o));1===r?(t=e[n-1],i.push(A[t>>2]+A[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],i.push(A[t>>10]+A[t>>4&63]+A[t<<2&63]+"="));return i.join("")}},A=[],C=[],R="undefined"!=typeof Uint8Array?Uint8Array:Array,O="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",T=0;T<64;++T)A[T]=O[T],C[O.charCodeAt(T)]=T;function U(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function L(e,t,n){for(var r,i,o=[],s=t;s<n;s+=3)r=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),o.push(A[(i=r)>>18&63]+A[i>>12&63]+A[i>>6&63]+A[63&i]);return o.join("")}C["-".charCodeAt(0)]=62,C["_".charCodeAt(0)]=63;var $={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(e,t,n,r,i){var o,s,a=8*i-r-1,u=(1<<a)-1,c=u>>1,l=-7,f=n?i-1:0,d=n?-1:1,h=e[t+f];for(f+=d,o=h&(1<<-l)-1,h>>=-l,l+=a;l>0;o=256*o+e[t+f],f+=d,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=r;l>0;s=256*s+e[t+f],f+=d,l-=8);if(0===o)o=1-c;else{if(o===u)return s?NaN:1/0*(h?-1:1);s+=Math.pow(2,r),o-=c}return(h?-1:1)*s*Math.pow(2,o-r)},write:function(e,t,n,r,i,o){var s,a,u,c=8*o-i-1,l=(1<<c)-1,f=l>>1,d=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:o-1,p=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),(t+=s+f>=1?d/u:d*Math.pow(2,1-f))*u>=2&&(s++,u/=2),s+f>=l?(a=0,s=l):s+f>=1?(a=(t*u-1)*Math.pow(2,i),s+=f):(a=t*Math.pow(2,f-1)*Math.pow(2,i),s=0));i>=8;e[n+h]=255&a,h+=p,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;e[n+h]=255&s,h+=p,s/=256,c-=8);e[n+h-p]|=128*g}};
/*!
   * The buffer module from node.js, for the browser.
   *
   * @author   Feross Aboukhadijeh <https://feross.org>
   * @license  MIT
   */
!function(e){const t=B,n=$,r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=c,e.SlowBuffer=function(e){+e!=e&&(e=0);return c.alloc(+e)},e.INSPECT_MAX_BYTES=50;const i=2147483647;e.kMaxLength=i;const{Uint8Array:o,ArrayBuffer:s,SharedArrayBuffer:a}=globalThis;function u(e){if(e>i)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new o(e);return Object.setPrototypeOf(t,c.prototype),t}function c(e,t,n){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return d(e)}return l(e,t,n)}function l(e,t,n){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!c.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const n=0|y(e,t);let r=u(n);const i=r.write(e,t);i!==n&&(r=r.slice(0,i));return r}(e,t);if(s.isView(e))return function(e){if(Z(e,o)){const t=new o(e);return p(t.buffer,t.byteOffset,t.byteLength)}return h(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Z(e,s)||e&&Z(e.buffer,s))return p(e,t,n);if(void 0!==a&&(Z(e,a)||e&&Z(e.buffer,a)))return p(e,t,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return c.from(r,t,n);const i=function(e){if(c.isBuffer(e)){const t=0|g(e.length),n=u(t);return 0===n.length||e.copy(n,0,0,t),n}if(void 0!==e.length)return"number"!=typeof e.length||K(e.length)?u(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return c.from(e[Symbol.toPrimitive]("string"),t,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function f(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e){return f(e),u(e<0?0:0|g(e))}function h(e){const t=e.length<0?0:0|g(e.length),n=u(t);for(let r=0;r<t;r+=1)n[r]=255&e[r];return n}function p(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===n?new o(e):void 0===n?new o(e,t):new o(e,t,n),Object.setPrototypeOf(r,c.prototype),r}function g(e){if(e>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|e}function y(e,t){if(c.isBuffer(e))return e.length;if(s.isView(e)||Z(e,s))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const n=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return V(e).length;default:if(i)return r?-1:W(e).length;t=(""+t).toLowerCase(),i=!0}}function w(e,t,n){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return L(this,t,n);case"utf8":case"utf-8":return R(this,t,n);case"ascii":return T(this,t,n);case"latin1":case"binary":return U(this,t,n);case"base64":return C(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return x(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function m(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function v(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),K(n=+n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=c.from(t,r)),c.isBuffer(t))return 0===t.length?-1:b(e,t,n,r,i);if("number"==typeof t)return t&=255,"function"==typeof o.prototype.indexOf?i?o.prototype.indexOf.call(e,t,n):o.prototype.lastIndexOf.call(e,t,n):b(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function b(e,t,n,r,i){let o,s=1,a=e.length,u=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,u/=2,n/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){let r=-1;for(o=n;o<a;o++)if(c(e,o)===c(t,-1===r?0:o-r)){if(-1===r&&(r=o),o-r+1===u)return r*s}else-1!==r&&(o-=o-r),r=-1}else for(n+u>a&&(n=a-u),o=n;o>=0;o--){let n=!0;for(let r=0;r<u;r++)if(c(e,o+r)!==c(t,r)){n=!1;break}if(n)return o}return-1}function I(e,t,n,r){n=Number(n)||0;const i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;const o=t.length;let s;for(r>o/2&&(r=o/2),s=0;s<r;++s){const r=parseInt(t.substr(2*s,2),16);if(K(r))return s;e[n+s]=r}return s}function S(e,t,n,r){return Q(W(t,e.length-n),e,n,r)}function E(e,t,n,r){return Q(function(e){const t=[];for(let n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function k(e,t,n,r){return Q(V(t),e,n,r)}function A(e,t,n,r){return Q(function(e,t){let n,r,i;const o=[];for(let s=0;s<e.length&&!((t-=2)<0);++s)n=e.charCodeAt(s),r=n>>8,i=n%256,o.push(i),o.push(r);return o}(t,e.length-n),e,n,r)}function C(e,n,r){return 0===n&&r===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(n,r))}function R(e,t,n){n=Math.min(e.length,n);const r=[];let i=t;for(;i<n;){const t=e[i];let o=null,s=t>239?4:t>223?3:t>191?2:1;if(i+s<=n){let n,r,a,u;switch(s){case 1:t<128&&(o=t);break;case 2:n=e[i+1],128==(192&n)&&(u=(31&t)<<6|63&n,u>127&&(o=u));break;case 3:n=e[i+1],r=e[i+2],128==(192&n)&&128==(192&r)&&(u=(15&t)<<12|(63&n)<<6|63&r,u>2047&&(u<55296||u>57343)&&(o=u));break;case 4:n=e[i+1],r=e[i+2],a=e[i+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&(u=(15&t)<<18|(63&n)<<12|(63&r)<<6|63&a,u>65535&&u<1114112&&(o=u))}}null===o?(o=65533,s=1):o>65535&&(o-=65536,r.push(o>>>10&1023|55296),o=56320|1023&o),r.push(o),i+=s}return function(e){const t=e.length;if(t<=O)return String.fromCharCode.apply(String,e);let n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=O));return n}(r)}c.TYPED_ARRAY_SUPPORT=function(){try{const e=new o(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,o.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),c.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}}),c.poolSize=8192,c.from=function(e,t,n){return l(e,t,n)},Object.setPrototypeOf(c.prototype,o.prototype),Object.setPrototypeOf(c,o),c.alloc=function(e,t,n){return function(e,t,n){return f(e),e<=0?u(e):void 0!==t?"string"==typeof n?u(e).fill(t,n):u(e).fill(t):u(e)}(e,t,n)},c.allocUnsafe=function(e){return d(e)},c.allocUnsafeSlow=function(e){return d(e)},c.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==c.prototype},c.compare=function(e,t){if(Z(e,o)&&(e=c.from(e,e.offset,e.byteLength)),Z(t,o)&&(t=c.from(t,t.offset,t.byteLength)),!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let n=e.length,r=t.length;for(let i=0,o=Math.min(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);let n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;const r=c.allocUnsafe(t);let i=0;for(n=0;n<e.length;++n){let t=e[n];if(Z(t,o))i+t.length>r.length?(c.isBuffer(t)||(t=c.from(t)),t.copy(r,i)):o.prototype.set.call(r,t,i);else{if(!c.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,i)}i+=t.length}return r},c.byteLength=y,c.prototype._isBuffer=!0,c.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)m(this,t,t+1);return this},c.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)m(this,t,t+3),m(this,t+1,t+2);return this},c.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)m(this,t,t+7),m(this,t+1,t+6),m(this,t+2,t+5),m(this,t+3,t+4);return this},c.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?R(this,0,e):w.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){let t="";const n=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(t+=" ... "),"<Buffer "+t+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(e,t,n,r,i){if(Z(e,o)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;let s=(i>>>=0)-(r>>>=0),a=(n>>>=0)-(t>>>=0);const u=Math.min(s,a),l=this.slice(r,i),f=e.slice(t,n);for(let o=0;o<u;++o)if(l[o]!==f[o]){s=l[o],a=f[o];break}return s<a?-1:a<s?1:0},c.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},c.prototype.indexOf=function(e,t,n){return v(this,e,t,n,!0)},c.prototype.lastIndexOf=function(e,t,n){return v(this,e,t,n,!1)},c.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}const i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let o=!1;for(;;)switch(r){case"hex":return I(this,e,t,n);case"utf8":case"utf-8":return S(this,e,t,n);case"ascii":case"latin1":case"binary":return E(this,e,t,n);case"base64":return k(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const O=4096;function T(e,t,n){let r="";n=Math.min(e.length,n);for(let i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function U(e,t,n){let r="";n=Math.min(e.length,n);for(let i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function L(e,t,n){const r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);let i="";for(let o=t;o<n;++o)i+=ee[e[o]];return i}function x(e,t,n){const r=e.slice(t,n);let i="";for(let o=0;o<r.length-1;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function F(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function H(e,t,n,r,i,o){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function P(e,t,n,r,i){J(t,r,i,e,n,7);let o=Number(t&BigInt(4294967295));e[n++]=o,o>>=8,e[n++]=o,o>>=8,e[n++]=o,o>>=8,e[n++]=o;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[n++]=s,s>>=8,e[n++]=s,s>>=8,e[n++]=s,s>>=8,e[n++]=s,n}function D(e,t,n,r,i){J(t,r,i,e,n,7);let o=Number(t&BigInt(4294967295));e[n+7]=o,o>>=8,e[n+6]=o,o>>=8,e[n+5]=o,o>>=8,e[n+4]=o;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[n+3]=s,s>>=8,e[n+2]=s,s>>=8,e[n+1]=s,s>>=8,e[n]=s,n+8}function N(e,t,n,r,i,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function _(e,t,r,i,o){return t=+t,r>>>=0,o||N(e,0,r,4),n.write(e,t,r,i,23,4),r+4}function M(e,t,r,i,o){return t=+t,r>>>=0,o||N(e,0,r,8),n.write(e,t,r,i,52,8),r+8}c.prototype.slice=function(e,t){const n=this.length;(e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,c.prototype),r},c.prototype.readUintLE=c.prototype.readUIntLE=function(e,t,n){e>>>=0,t>>>=0,n||F(e,t,this.length);let r=this[e],i=1,o=0;for(;++o<t&&(i*=256);)r+=this[e+o]*i;return r},c.prototype.readUintBE=c.prototype.readUIntBE=function(e,t,n){e>>>=0,t>>>=0,n||F(e,t,this.length);let r=this[e+--t],i=1;for(;t>0&&(i*=256);)r+=this[e+--t]*i;return r},c.prototype.readUint8=c.prototype.readUInt8=function(e,t){return e>>>=0,t||F(e,1,this.length),this[e]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(e,t){return e>>>=0,t||F(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(e,t){return e>>>=0,t||F(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(e,t){return e>>>=0,t||F(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(e,t){return e>>>=0,t||F(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readBigUInt64LE=te((function(e){Y(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||X(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+n*2**24;return BigInt(r)+(BigInt(i)<<BigInt(32))})),c.prototype.readBigUInt64BE=te((function(e){Y(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||X(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+n;return(BigInt(r)<<BigInt(32))+BigInt(i)})),c.prototype.readIntLE=function(e,t,n){e>>>=0,t>>>=0,n||F(e,t,this.length);let r=this[e],i=1,o=0;for(;++o<t&&(i*=256);)r+=this[e+o]*i;return i*=128,r>=i&&(r-=Math.pow(2,8*t)),r},c.prototype.readIntBE=function(e,t,n){e>>>=0,t>>>=0,n||F(e,t,this.length);let r=t,i=1,o=this[e+--r];for(;r>0&&(i*=256);)o+=this[e+--r]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*t)),o},c.prototype.readInt8=function(e,t){return e>>>=0,t||F(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){e>>>=0,t||F(e,2,this.length);const n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt16BE=function(e,t){e>>>=0,t||F(e,2,this.length);const n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt32LE=function(e,t){return e>>>=0,t||F(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return e>>>=0,t||F(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readBigInt64LE=te((function(e){Y(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||X(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(n<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),c.prototype.readBigInt64BE=te((function(e){Y(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||X(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+n)})),c.prototype.readFloatLE=function(e,t){return e>>>=0,t||F(e,4,this.length),n.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return e>>>=0,t||F(e,4,this.length),n.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return e>>>=0,t||F(e,8,this.length),n.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return e>>>=0,t||F(e,8,this.length),n.read(this,e,!1,52,8)},c.prototype.writeUintLE=c.prototype.writeUIntLE=function(e,t,n,r){if(e=+e,t>>>=0,n>>>=0,!r){H(this,e,t,n,Math.pow(2,8*n)-1,0)}let i=1,o=0;for(this[t]=255&e;++o<n&&(i*=256);)this[t+o]=e/i&255;return t+n},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(e,t,n,r){if(e=+e,t>>>=0,n>>>=0,!r){H(this,e,t,n,Math.pow(2,8*n)-1,0)}let i=n-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+n},c.prototype.writeUint8=c.prototype.writeUInt8=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,1,255,0),this[t]=255&e,t+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigUInt64LE=te((function(e,t=0){return P(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),c.prototype.writeBigUInt64BE=te((function(e,t=0){return D(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),c.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*n-1);H(this,e,t,n,r-1,-r)}let i=0,o=1,s=0;for(this[t]=255&e;++i<n&&(o*=256);)e<0&&0===s&&0!==this[t+i-1]&&(s=1),this[t+i]=(e/o|0)-s&255;return t+n},c.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*n-1);H(this,e,t,n,r-1,-r)}let i=n-1,o=1,s=0;for(this[t+i]=255&e;--i>=0&&(o*=256);)e<0&&0===s&&0!==this[t+i+1]&&(s=1),this[t+i]=(e/o|0)-s&255;return t+n},c.prototype.writeInt8=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeInt16BE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeInt32LE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},c.prototype.writeInt32BE=function(e,t,n){return e=+e,t>>>=0,n||H(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigInt64LE=te((function(e,t=0){return P(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),c.prototype.writeBigInt64BE=te((function(e,t=0){return D(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),c.prototype.writeFloatLE=function(e,t,n){return _(this,e,t,!0,n)},c.prototype.writeFloatBE=function(e,t,n){return _(this,e,t,!1,n)},c.prototype.writeDoubleLE=function(e,t,n){return M(this,e,t,!0,n)},c.prototype.writeDoubleBE=function(e,t,n){return M(this,e,t,!1,n)},c.prototype.copy=function(e,t,n,r){if(!c.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);const i=r-n;return this===e&&"function"==typeof o.prototype.copyWithin?this.copyWithin(t,n,r):o.prototype.set.call(e,this.subarray(n,r),t),i},c.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!c.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;let i;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(i=t;i<n;++i)this[i]=e;else{const o=c.isBuffer(e)?e:c.from(e,r),s=o.length;if(0===s)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<n-t;++i)this[i+t]=o[i%s]}return this};const j={};function z(e,t,n){j[e]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function q(e){let t="",n=e.length;const r="-"===e[0]?1:0;for(;n>=r+4;n-=3)t=`_${e.slice(n-3,n)}${t}`;return`${e.slice(0,n)}${t}`}function J(e,t,n,r,i,o){if(e>n||e<t){const n="bigint"==typeof t?"n":"";let r;throw r=0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(o+1)}${n}`:`>= -(2${n} ** ${8*(o+1)-1}${n}) and < 2 ** ${8*(o+1)-1}${n}`,new j.ERR_OUT_OF_RANGE("value",r,e)}!function(e,t,n){Y(t,"offset"),void 0!==e[t]&&void 0!==e[t+n]||X(t,e.length-(n+1))}(r,i,o)}function Y(e,t){if("number"!=typeof e)throw new j.ERR_INVALID_ARG_TYPE(t,"number",e)}function X(e,t,n){if(Math.floor(e)!==e)throw Y(e,n),new j.ERR_OUT_OF_RANGE("offset","an integer",e);if(t<0)throw new j.ERR_BUFFER_OUT_OF_BOUNDS;throw new j.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${t}`,e)}z("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),z("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),z("ERR_OUT_OF_RANGE",(function(e,t,n){let r=`The value of "${e}" is out of range.`,i=n;return Number.isInteger(n)&&Math.abs(n)>2**32?i=q(String(n)):"bigint"==typeof n&&(i=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(i=q(i)),i+="n"),r+=` It must be ${t}. Received ${i}`,r}),RangeError);const G=/[^+/0-9A-Za-z-_]/g;function W(e,t){let n;t=t||1/0;const r=e.length;let i=null;const o=[];for(let s=0;s<r;++s){if(n=e.charCodeAt(s),n>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function V(e){return t.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Q(e,t,n,r){let i;for(i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function Z(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function K(e){return e!=e}const ee=function(){const e="0123456789abcdef",t=new Array(256);for(let n=0;n<16;++n){const r=16*n;for(let i=0;i<16;++i)t[r+i]=e[n]+e[i]}return t}();function te(e){return"undefined"==typeof BigInt?ne:e}function ne(){throw new Error("BigInt not supported")}}(k);const x=k.Buffer;class F{constructor(e,t){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=e,this.environmentId=t}async uploadFile(e,{allowedFileExtensions:t,surveyId:n}={}){if(!e.name||!e.type||!e.base64)throw new Error("Invalid file object");const r={fileName:e.name,fileType:e.type,allowedFileExtensions:t,surveyId:n},i=await fetch(`${this.apiHost}/api/v1/client/${this.environmentId}/storage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok)throw new Error(`Upload failed with status: ${String(i.status)}`);const o=await i.json(),{data:s}=o,{signedUrl:a,fileUrl:u,signingData:c,presignedFields:l,updatedFileName:f}=s;let d={};if(c){const{signature:t,timestamp:r,uuid:i}=c;d={"X-File-Type":e.type,"X-File-Name":encodeURIComponent(f),"X-Survey-ID":n??"","X-Signature":t,"X-Timestamp":String(r),"X-UUID":i}}const h={},p=new FormData;if(l){Object.keys(l).forEach((e=>{p.append(e,l[e])}));try{const t=x.from(e.base64.split(",")[1],"base64"),n=new Blob([t],{type:e.type});p.append("file",n)}catch(w){throw console.error({buffErr:w}),new Error("Error uploading file")}}h.fileBase64String=e.base64;let g={};const y=a.replace("http://localhost:3000",this.apiHost);try{g=await fetch(y,{method:"POST",...c?{headers:{...d}}:{},body:l?p:JSON.stringify(h)})}catch(m){console.error("Error uploading file",m)}if(!g.ok){if(c){const e=await g.json(),t=new Error(e.message);throw t.name="FileTooLargeError",t}const e=await g.text();if(l&&e.includes("EntityTooLarge")){const e=new Error("File size exceeds the size limit for your plan");throw e.name="FileTooLargeError",e}throw new Error(`Upload failed with status: ${String(g.status)}`)}return u}}class H{constructor(e){w(this,"response"),w(this,"display"),w(this,"people"),w(this,"storage"),w(this,"attribute");const{apiHost:t,environmentId:n}=e;this.response=new E(t,n),this.display=new I(t,n),this.people=new S(t,n),this.attribute=new b(t,n),this.storage=new F(t,n)}}class P{constructor(e){w(this,"client"),this.client=new H(e)}}const D=e=>new Promise((t=>setTimeout(t,e)));class N{constructor(e,n){t(this,"queue",[]),t(this,"config"),t(this,"surveyState"),t(this,"isRequestInProgress",!1),t(this,"api"),this.config=e,this.surveyState=n,this.api=new P({apiHost:e.apiHost,environmentId:e.environmentId})}add(e){this.surveyState.accumulateResponse(e),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState),this.queue.push(e),this.processQueue()}async processQueue(){if(this.isRequestInProgress)return;if(0===this.queue.length)return;this.isRequestInProgress=!0;const e=this.queue[0];let t=0;for(;t<this.config.retryAttempts;){if(await this.sendResponse(e)){this.queue.shift();break}console.error(`Formbricks: Failed to send response. Retrying... ${t}`),await D(1e3),t++}t>=this.config.retryAttempts?(console.error("Failed to send response after 2 attempts."),this.config.onResponseSendingFailed&&this.config.onResponseSendingFailed(e),this.isRequestInProgress=!1):(e.finished&&this.config.onResponseSendingFinished&&this.config.onResponseSendingFinished(),this.isRequestInProgress=!1,this.processQueue())}async sendResponse(e){try{if(null!==this.surveyState.responseId)await this.api.client.response.update({...e,responseId:this.surveyState.responseId});else{const t=await this.api.client.response.create({...e,surveyId:this.surveyState.surveyId,userId:this.surveyState.userId||null,singleUseId:this.surveyState.singleUseId||null,data:{...e.data,...e.hiddenFields},displayId:this.surveyState.displayId});if(!t.ok)throw new Error("Could not create response");this.surveyState.updateResponseId(t.data.id),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState)}return!0}catch(t){return console.error(t),!1}}updateSurveyState(e){this.surveyState=e}}class _{constructor(e,n,r,i){t(this,"responseId",null),t(this,"displayId",null),t(this,"userId",null),t(this,"surveyId"),t(this,"responseAcc",{finished:!1,data:{},ttc:{},variables:{}}),t(this,"singleUseId"),this.surveyId=e,this.userId=i??null,this.singleUseId=n??null,this.responseId=r??null}setSurveyId(e){this.surveyId=e,this.clear()}copy(){const e=new _(this.surveyId,this.singleUseId??void 0,this.responseId??void 0,this.userId??void 0);return e.responseId=this.responseId,e.responseAcc=this.responseAcc,e}updateResponseId(e){this.responseId=e}updateDisplayId(e){this.displayId=e}updateUserId(e){this.userId=e}accumulateResponse(e){this.responseAcc={finished:e.finished,ttc:e.ttc,data:{...this.responseAcc.data,...e.data},variables:e.variables,displayId:e.displayId}}isResponseFinished(){return this.responseAcc.finished}clear(){this.responseId=null,this.responseAcc={finished:!1,data:{},ttc:{},variables:{}}}}const M=(e,t)=>{var n;return e.styling.allowStyleOverwrite&&e.styling.allowStyleOverwrite&&(null==(n=t.styling)?void 0:n.overwriteThemeStyling)?t.styling:e.styling},j=(e,t)=>{const n=Math.abs(t.getTime()-e.getTime());return Math.floor(n/864e5)},z=a.getInstance(),q=e=>{if(!e||0===e.length)return!0;const t=window.location.href;return e.some((e=>((e,t,n)=>{switch(n){case"exactMatch":return e===t;case"contains":return e.includes(t);case"startsWith":return e.startsWith(t);case"endsWith":return e.endsWith(t);case"notMatch":return e!==t;case"notContains":return!e.includes(t);default:return!1}})(t,e.value,e.rule)))},J=e=>{var t;const n=null==(t=e.languages)?void 0:t.find((e=>!0===e.default));if(n)return n.language.code},Y=()=>window.location.search.includes("formbricksDebug=true"),X=(e,t)=>{const{product:n,surveys:r}=e.data,{displays:i,responses:o,lastDisplayAt:s,segments:a,userId:u}=t.data;if(!i)return[];let c=r.filter((e=>{switch(e.displayOption){case"respondMultiple":return!0;case"displayOnce":return 0===i.filter((t=>t.surveyId===e.id)).length;case"displayMultiple":return 0===o.filter((t=>t===e.id)).length;case"displaySome":return null===e.displayLimit||!o.filter((t=>t===e.id)).length&&i.filter((t=>t.surveyId===e.id)).length<e.displayLimit;default:throw Error("Invalid displayOption")}}));return c=c.filter((e=>{if(s){if(null!==e.recontactDays){const t=i.filter((t=>t.surveyId===e.id))[0];return!t||j(new Date,new Date(t.createdAt))>=e.recontactDays}return null===n.recontactDays||j(new Date,new Date(s))>=n.recontactDays}return!0})),u?a.length?c.filter((e=>{var t;return(null==(t=e.segment)?void 0:t.id)&&a.includes(e.segment.id)})):[]:c},G=g.getInstance(),W=a.getInstance();let V=!1,Q=e=>{},Z=e=>{};const K=e=>{V=e},ee=async(e,t,n)=>{if(e.displayPercentage){if(!(r=e.displayPercentage,Math.floor(1e4*Math.random())/100<=r))return void W.debug(`Survey display of "${e.name}" skipped based on displayPercentage.`)}var r;const i=((e,t)=>{const{enabled:n,fieldIds:r}=e||{};let i={};if(n){if(r&&t){const e=[];i=Object.keys(t).reduce(((n,i)=>((null==r?void 0:r.includes(i))?n[i]=null==t?void 0:t[i]:e.push(i),n)),{}),e.length>0&&z.error(`Unknown hidden fields: ${e.join(", ")}. Please add them to the survey hidden fields.`)}}else z.error("Hidden fields are not enabled for this survey");return i})(e.hiddenFields,null==n?void 0:n.hiddenFields);await te(e,t,i)},te=async(e,t,n={})=>{if(V)return void W.debug("A survey is already running. Skipping.");K(!0),e.delay&&W.debug(`Delaying survey "${e.name}" by ${e.delay} seconds.`);const{product:r}=G.get().environmentState.data??{},{attributes:i}=G.get().personState.data??{},o=e.languages.length>1;let s="default";if(o){const t=((e,t)=>{const n=t.language,r=e.languages.map((e=>e.language.code));if(n){const t=e.languages.find((e=>{var t;return e.language.code===n.toLowerCase()||(null==(t=e.language.alias)?void 0:t.toLowerCase())===n.toLowerCase()}));if(null==t?void 0:t.default)return"default";if(!t||!(null==t?void 0:t.enabled)||!r.includes(t.language.code))return;return t.language.code}return"default"})(e,i);if(!t)return W.debug(`Survey "${e.name}" is not available in specified language.`),void K(!0);s=t}const a=new _(e.id,null,null,G.get().personState.data.userId),u=new N({apiHost:G.get().apiHost,environmentId:G.get().environmentId,retryAttempts:2,onResponseSendingFailed:()=>{Q(!0)},onResponseSendingFinished:()=>{Z(!0)}},a),c=e.productOverwrites??{},l=c.clickOutsideClose??r.clickOutsideClose,f=c.darkOverlay??r.darkOverlay,d=c.placement??r.placement,h=r.inAppSurveyBranding,p=await oe();setTimeout((()=>{p.renderSurveyModal({survey:e,isBrandingEnabled:h,clickOutside:l,darkOverlay:f,languageCode:s,placement:d,styling:M(r,e),getSetIsError:e=>{Q=e},getSetIsResponseSendingFinished:e=>{Z=e},onDisplay:async()=>{const{userId:t}=G.get().personState.data,n=new P({apiHost:G.get().apiHost,environmentId:G.get().environmentId}),r=await n.client.display.create({surveyId:e.id,...t&&{userId:t}});if(!r.ok)throw new Error("Could not create display");const{id:i}=r.data;a.updateDisplayId(i),u.updateSurveyState(a);const o=G.get().personState.data.displays,s={surveyId:e.id,createdAt:new Date},c=o?[...o,s]:[s],l=G.get(),f={...l.personState,data:{...l.personState.data,displays:c,lastDisplayAt:new Date}},d=X(l.environmentState,f);G.update({...l,environmentState:l.environmentState,personState:f,filteredSurveys:d})},onResponse:r=>{const{userId:i}=G.get().personState.data,o=null===a.responseId;if(i&&a.updateUserId(i),u.updateSurveyState(a),u.add({data:r.data,ttc:r.ttc,finished:r.finished,language:"default"===r.language?J(e):r.language,meta:{url:window.location.href,action:t},variables:r.variables,hiddenFields:n,displayId:a.displayId}),o){const e=G.get().personState.data.responses,t={...G.get().personState,data:{...G.get().personState.data,responses:[...e,a.surveyId]}},n=X(G.get().environmentState,t);G.update({...G.get(),environmentState:G.get().environmentState,personState:t,filteredSurveys:n})}},onClose:ne,onFileUpload:async(e,t)=>{const n=new P({apiHost:G.get().apiHost,environmentId:G.get().environmentId});return await n.client.storage.uploadFile({type:e.type,name:e.name,base64:e.base64},t)},onRetry:()=>{Q(!1),u.processQueue()},hiddenFieldsRecord:n})}),1e3*e.delay)},ne=async()=>{ie(),re();const{environmentState:e,personState:t}=G.get(),n=X(e,t);G.update({...G.get(),environmentState:e,personState:t,filteredSurveys:n}),K(!1)},re=()=>{const e=document.createElement("div");e.id=o,document.body.appendChild(e)},ie=()=>{var e;null==(e=document.getElementById(o))||e.remove()},oe=()=>new Promise(((e,t)=>{if(window.formbricksSurveys)e(window.formbricksSurveys);else{const n=document.createElement("script");n.src=`${G.get().apiHost}/api/packages/surveys`,n.async=!0,n.onload=()=>e(window.formbricksSurveys),n.onerror=e=>{console.error("Failed to load Formbricks Surveys library:",e),t(e)},document.head.appendChild(n)}})),se=a.getInstance(),ae=g.getInstance(),ue=async(e,t,n)=>{const r=t||e;se.debug(`Formbricks: Action "${r}" tracked`);const i=ae.get().filteredSurveys;if(i&&i.length>0)for(const o of i)for(const t of o.triggers)t.actionClass.name===e&&await ee(o,e,n);else se.debug("No active surveys to display");return{ok:!0,value:void 0}},ce=(e,t)=>{const n=ae.get().environmentState.data.actionClasses.filter((e=>"code"===e.type)).find((t=>t.key===e));return n?ue(n.name,e,t):c({code:"invalid_code",message:`${e} action unknown. Please add this action in Formbricks first in order to use it in your code.`})},le=e=>ue(e),fe=g.getInstance(),de=a.getInstance();let he=null;const pe={expiresAt:null,data:{userId:null,segments:[],displays:[],responses:[],attributes:{},lastDisplayAt:null}},ge=async({apiHost:e,environmentId:t,userId:n},r=!1)=>{let i={};(r||Y())&&(i.cache="no-cache",de.debug("No cache option set for sync"));const o=`${e}/api/v1/client/${t}/identify/people/${n}`,s=await fetch(o,i);if(!s.ok){const e=await s.json();throw c({code:"network_error",status:s.status,message:"Error syncing with backend",url:new URL(o),responseMessage:e.message})}const a=await s.json(),{data:u}=a;console.log("Person state fetched",u);const l={expiresAt:new Date((new Date).getTime()+18e5),data:{userId:n,segments:[],displays:[],responses:[],attributes:{},lastDisplayAt:null}};return Object.keys(u).length?{data:{...u},expiresAt:new Date((new Date).getTime()+18e5)}:l},ye=()=>{he&&(clearInterval(he),he=null)},we=g.getInstance(),me=a.getInstance(),ve=async(e,t)=>{if("userId"===e)return me.error("Setting userId is no longer supported. Please set the userId in the init call instead."),{ok:!0,value:void 0};const n=we.get().personState.data.userId;if(me.debug("Setting attribute: "+e+" to value: "+t),((e,t)=>we.get().personState.data.attributes[e]===t)(e,t.toString()))return me.debug("Attribute already set to this value. Skipping update."),{ok:!0,value:void 0};if(!n)return me.error("UserId not provided, please provide a userId in the init method before setting attributes."),{ok:!0,value:void 0};const r=await(async(e,t)=>{var n;const{apiHost:r,environmentId:i}=we.get(),o=we.get().personState.data.userId;if(!o)return c({code:"network_error",status:500,message:"Missing userId",url:`${r}/api/v1/client/${i}/people/${o}/attributes`,responseMessage:"Missing userId"});const s=new P({apiHost:r,environmentId:i}),a=await s.client.attribute.update({userId:o,attributes:{[e]:t}});return a.ok?a.data.changed?(me.debug("Attribute updated in Formbricks"),{ok:!0,value:{changed:!0,message:"Attribute updated in Formbricks"}}):{ok:!0,value:{changed:!1,message:"Attribute not updated in Formbricks"}}:(null==(n=a.error.details)?void 0:n.ignore)?(me.error(a.error.message??`Error updating person with userId ${o}`),{ok:!0,value:{changed:!1,message:a.error.message}}):c({code:"network_error",status:a.error.status??500,message:a.error.message??`Error updating person with userId ${o}`,url:`${we.get().apiHost}/api/v1/client/${i}/people/${o}/attributes`,responseMessage:a.error.message})})(e,t.toString());if(r.ok){if(r.value.changed){const e=await ge({apiHost:we.get().apiHost,environmentId:we.get().environmentId,userId:n},!0),t=X(we.get().environmentState,e);we.update({...we.get(),personState:e,filteredSurveys:t})}return{ok:!0,value:void 0}}return c(r.error)},be=e=>async(...t)=>{try{return{ok:!0,data:await e(...t)}}catch(n){return{ok:!1,error:n}}},Ie=g.getInstance(),Se=a.getInstance();let Ee=null;const ke=async({apiHost:e,environmentId:t},n=!1)=>{let r={};(n||Y())&&(r.cache="no-cache",Se.debug("No cache option set for sync"));const i=`${e}/api/v1/client/${t}/environment`,o=await fetch(i,r);if(!o.ok){const e=await o.json();throw c({code:"network_error",status:o.status,message:"Error syncing with backend",url:new URL(i),responseMessage:e.message})}const s=await o.json(),{data:a}=s;return{data:{...a},expiresAt:new Date((new Date).getTime()+18e5)}},Be=()=>{Ee&&(clearInterval(Ee),Ee=null)},Ae=g.getInstance(),Ce=a.getInstance(),Re=h.getInstance(),Oe=["hashchange","popstate","pushstate","replacestate","load"];let Te=!1;const Ue=async()=>{var e;Ce.debug(`Checking page url: ${window.location.href}`);const t=Ae.get().environmentState.data.actionClasses.filter((e=>{var t;return"noCode"===e.type&&"pageView"===(null==(t=e.noCodeConfig)?void 0:t.type)}));for(const n of t){const t=(null==(e=n.noCodeConfig)?void 0:e.urlFilters)??[];if(!q(t))continue;const r=await le(n.name);if(!0!==r.ok)return c(r.error)}return{ok:!0,value:void 0}},Le=()=>Ue(),$e=()=>{"undefined"!=typeof window&&Te&&(Oe.forEach((e=>window.removeEventListener(e,Le))),Te=!1)};let xe=!1;const Fe=e=>{const{environmentState:t}=Ae.get();if(!t)return;const{actionClasses:n=[]}=t.data,r=n.filter((e=>{var t;return"noCode"===e.type&&"click"===(null==(t=e.noCodeConfig)?void 0:t.type)})),i=e.target;r.forEach((e=>{((e,t)=>{var n;if("click"!==(null==(n=t.noCodeConfig)?void 0:n.type))return!1;const r=t.noCodeConfig.elementSelector.innerHtml,i=t.noCodeConfig.elementSelector.cssSelector,o=t.noCodeConfig.urlFilters;if(!r&&!i)return!1;if(r&&e.innerHTML!==r)return!1;if(i){const t=i.split(/\s*(?=[.#])/);for(let n of t)if(!e.matches(n))return!1}return!!q(o)})(i,e)&&le(e.name).then((e=>{var t,n,r;n=e=>{},r=e=>Re.handle(e),!0===(t=e).ok?n(t.value):r(t.error)}))}))},He=e=>Fe(e),Pe=()=>{xe&&(document.removeEventListener("click",He),xe=!1)};let De=!1;const Ne=e=>(async e=>{var t;const{environmentState:n}=Ae.get(),{actionClasses:r=[]}=n.data??{},i=r.filter((e=>{var t;return"noCode"===e.type&&"exitIntent"===(null==(t=e.noCodeConfig)?void 0:t.type)}));if(e.clientY<=0&&i.length>0)for(const o of i){const e=(null==(t=o.noCodeConfig)?void 0:t.urlFilters)??[];if(!q(e))continue;const n=await le(o.name);if(!0!==n.ok)return c(n.error)}})(e),_e=()=>{De&&(document.removeEventListener("mouseleave",Ne),De=!1)};let Me=!1,je=!1;const ze=()=>(async()=>{var e;const t=window.scrollY,n=window.innerHeight,r=document.documentElement.scrollHeight;if(0===t&&(je=!1),!je&&t/(r-n)>=.5){je=!0;const{environmentState:t}=Ae.get(),{actionClasses:n=[]}=t.data??{},r=n.filter((e=>{var t;return"noCode"===e.type&&"fiftyPercentScroll"===(null==(t=e.noCodeConfig)?void 0:t.type)}));for(const i of r){const t=(null==(e=i.noCodeConfig)?void 0:e.urlFilters)??[];if(!q(t))continue;const n=await le(i.name);if(!0!==n.ok)return c(n.error)}}return{ok:!0,value:void 0}})(),qe=()=>{Me&&(window.removeEventListener("scroll",ze),Me=!1)};let Je=!1;const Ye=()=>{"undefined"!=typeof window&&null===Ee&&(Ee=window.setInterval((async()=>{const e=Ie.get().environmentState.expiresAt;try{if(e&&new Date(e)>=new Date)return;Se.debug("Environment State has expired. Starting sync.");const t=Ie.get().personState,n=await ke({apiHost:Ie.get().apiHost,environmentId:Ie.get().environmentId},!0),r=X(n,t);Ie.update({...Ie.get(),environmentState:n,filteredSurveys:r})}catch(t){console.error(`Error during expiry check: ${t}`),Se.debug("Extending config and try again later.");const e=Ie.get();Ie.update(e)}}),6e4)),"undefined"!=typeof window&&null===he&&(he=window.setInterval((async()=>{fe.get().personState.data.userId&&fe.update({...fe.get(),personState:{...fe.get().personState,expiresAt:new Date((new Date).getTime()+18e5)}})}),6e4)),"undefined"==typeof window||Te||(Oe.forEach((e=>window.addEventListener(e,Le))),Te=!0),"undefined"==typeof window||xe||(document.addEventListener("click",He),xe=!0),"undefined"==typeof document||De||(document.querySelector("body").addEventListener("mouseleave",Ne),De=!0),"undefined"==typeof window||Me||("complete"===document.readyState?window.addEventListener("scroll",ze):window.addEventListener("load",(()=>{window.addEventListener("scroll",ze)})),Me=!0)},Xe=()=>{Be(),ye(),$e(),Pe(),_e(),qe(),Je&&(window.removeEventListener("beforeunload",(()=>{Be(),ye(),$e(),Pe(),_e(),qe()})),Je=!1)},Ge=a.getInstance();let We=!1;const Ve=e=>{We=e},Qe=async e=>{var t,n;const o=Y();o&&Ge.configure({logLevel:"debug"});let s=g.getInstance();const{changed:a,newState:l}=(()=>{const e=localStorage.getItem(r),t=localStorage.getItem(i);if(e){localStorage.removeItem(r);const t=JSON.parse(e);if(t.environmentId&&t.apiHost&&t.environmentState&&t.personState&&t.filteredSurveys)return{changed:!0,newState:{...t}}}if(t){localStorage.removeItem(i);const e=JSON.parse(t);if(e.environmentId&&e.apiHost&&e.environmentState&&e.personState&&e.filteredSurveys)return{changed:!0}}return{changed:!1}})();if(a&&(s.resetConfig(),s=g.getInstance(),!e.userId&&l&&s.update(l)),We)return Ge.debug("Already initialized, skipping initialization."),{ok:!0,value:void 0};let f;try{f=s.get(),Ge.debug("Found existing configuration.")}catch(p){Ge.debug("No existing configuration found.")}if("error"===(null==(t=null==f?void 0:f.status)?void 0:t.value)){if(o)return Ge.debug("Formbricks is in error state, but debug mode is active. Resetting config and continuing."),s.resetConfig(),{ok:!0,value:void 0};Ge.debug("Formbricks was set to an error state.");const e=null==(n=null==f?void 0:f.status)?void 0:n.expiresAt;if(e&&new Date(e)>new Date)return Ge.debug("Error state is not expired, skipping initialization"),{ok:!0,value:void 0};Ge.debug("Error state is expired. Continue with initialization.")}if(h.getInstance().printStatus(),Ge.debug("Start initialize"),!e.environmentId)return Ge.debug("No environmentId provided"),c({code:"missing_field",field:"environmentId"});if(!e.apiHost)return Ge.debug("No apiHost provided"),c({code:"missing_field",field:"apiHost"});Ge.debug("Adding widget container to DOM"),re();let d=null;if(e.attributes)if(e.userId){const t=await(async(e,t,n,r)=>{var i;const o={...r};try{const e=we.get().personState.data.attributes;if(e)for(const[t,n]of Object.entries(e))o[t]===n&&delete o[t]}catch(p){me.debug("config not set; sending all attributes to backend")}if(0===Object.keys(o).length)return me.debug("No attributes to update. Skipping update."),u(o);me.debug("Updating attributes: "+JSON.stringify(o));const s=new P({apiHost:e,environmentId:t}),a=await s.client.attribute.update({userId:n,attributes:o});return a.ok?u(o):(null==(i=a.error.details)?void 0:i.ignore)?(me.error(a.error.message??`Error updating person with userId ${n}`),u(o)):c({code:"network_error",status:500,message:`Error updating person with userId ${n}`,url:`${e}/api/v1/client/${t}/people/${n}/attributes`,responseMessage:a.error.message})})(e.apiHost,e.environmentId,e.userId,e.attributes);if(!0!==t.ok)return c(t.error);d=t.value}else d={...e.attributes};if(f&&f.environmentState&&f.environmentId===e.environmentId&&f.apiHost===e.apiHost){Ge.debug("Configuration fits init parameters.");let t=!1,n=!1;new Date(f.environmentState.expiresAt)<new Date&&(Ge.debug("Environment state expired. Syncing."),t=!0),e.userId&&f.personState.expiresAt&&new Date(f.personState.expiresAt)<new Date&&(Ge.debug("Person state expired. Syncing."),n=!0);try{const r=t?await ke({apiHost:e.apiHost,environmentId:e.environmentId}):f.environmentState;let{personState:i}=f;n&&(i=e.userId?await ge({apiHost:e.apiHost,environmentId:e.environmentId,userId:e.userId}):pe);const o=X(r,i);s.update({...f,environmentState:r,personState:i,filteredSurveys:o});const a=o.map((e=>e.name));Ge.debug("Fetched "+a.length+" surveys during sync: "+a.join(", "))}catch(p){et(s)}}else{Ge.debug("No valid configuration found or it has been expired. Resetting config and creating new one."),s.resetConfig(),Ge.debug("Syncing.");try{const t=await ke({apiHost:e.apiHost,environmentId:e.environmentId},!1),n=e.userId?await ge({apiHost:e.apiHost,environmentId:e.environmentId,userId:e.userId},!1):pe,r=X(t,n);s.update({apiHost:e.apiHost,environmentId:e.environmentId,personState:n,environmentState:t,filteredSurveys:r})}catch(p){Ze()}await le("New Session")}return d&&Object.keys(d).length>0&&s.update({...s.get(),personState:{...s.get().personState,data:{...s.get().personState.data,attributes:{...s.get().personState.data.attributes,...d}}}}),Ge.debug("Adding event listeners"),Ye(),Je||(window.addEventListener("beforeunload",(()=>{Be(),ye(),$e(),Pe(),_e(),qe()})),Je=!0),Ve(!0),Ge.debug("Initialized"),Ue(),{ok:!0,value:void 0}},Ze=()=>{if(Y())return void Ge.debug("Not putting formbricks in error state because debug mode is active (no error state)");const e={status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}};throw l((()=>localStorage.setItem(n,JSON.stringify(e))))(),new Error("Could not initialize formbricks")},Ke=()=>{Ge.debug("Deinitializing"),ie(),K(!1),Xe(),Ve(!1)},et=e=>{Y()?Ge.debug("Not putting formbricks in error state because debug mode is active (no error state)"):(Ge.debug("Putting formbricks in error state"),e.update({...e.get(),status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}}),Ke())};const tt=g.getInstance(),nt=a.getInstance(),rt=async()=>{Ke(),tt.resetConfig()},it=async()=>{nt.debug("Resetting state & getting new state from backend"),ne();const e=tt.get().personState.data.userId,t={environmentId:tt.get().environmentId,apiHost:tt.get().apiHost,...e&&{userId:e},attributes:tt.get().personState.data.attributes};await rt();try{return await Qe(t),{ok:!0,value:void 0}}catch(n){return c(n)}};a.getInstance().debug("Create command queue");const ot=new class{constructor(){t(this,"queue",[]),t(this,"running",!1),t(this,"resolvePromise",null),t(this,"commandPromise",null)}add(e=!0,t,...n){this.queue.push({command:t,checkInitialized:e,commandArgs:n}),this.running||(this.commandPromise=new Promise((e=>{this.resolvePromise=e,this.run()})))}async wait(){this.running&&await this.commandPromise}async run(){for(this.running=!0;this.queue.length>0;){const e=h.getInstance(),t=this.queue.shift();if(!t)continue;if(t.checkInitialized){const t=(Ge.debug("Check if initialized"),We&&h.initialized?{ok:!0,value:void 0}:c({code:"not_initialized",message:"Formbricks not initialized. Call initialize() first."}));if(t&&!0!==t.ok){e.handle(t.error);continue}}const n=async()=>await(null==t?void 0:t.command.apply(null,null==t?void 0:t.commandArgs)),r=await be(n)();r&&(r.ok&&r.data&&!r.data.ok&&e.handle(r.data.error),!0!==r.ok&&e.handle(r.error))}this.running=!1,this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null,this.commandPromise=null)}},st=async(e,t)=>{ot.add(!0,ve,e,t),await ot.wait()};return{init:async e=>{h.init(e.errorHandler),ot.add(!1,Qe,e),await ot.wait()},setEmail:async e=>{st("email",e),await ot.wait()},setAttribute:st,track:async(e,t)=>{ot.add(!0,ce,e,t),await ot.wait()},logout:async()=>{ot.add(!0,rt),await ot.wait()},reset:async()=>{ot.add(!0,it),await ot.wait()},registerRouteChange:async()=>{ot.add(!0,Ue),await ot.wait()},getApi:()=>{const e=g.getInstance(),{environmentId:t,apiHost:n}=e.get();if(!t||!n)throw new Error("formbricks.init() must be called before getApi()");return new P({apiHost:n,environmentId:t})}}}));
//# sourceMappingURL=index.umd.cjs.map
