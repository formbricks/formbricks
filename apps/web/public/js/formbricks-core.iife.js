var formbricks=function(){"use strict";var t=Object.defineProperty,e=(e,n,r)=>((e,n,r)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r)(e,"symbol"!=typeof n?n+"":n,r);const n="formbricks-js",r="formbricks-js-website",i="formbricks-js-app",o="formbricks-app-container",s=class t{constructor(){e(this,"logLevel","error")}static getInstance(){return t.instance||(t.instance=new t),t.instance}configure(t){t&&void 0!==t.logLevel&&(this.logLevel=t.logLevel)}logger(t,e){if("debug"===e&&"debug"!==this.logLevel)return;const n=`ðŸ§± Formbricks - ${(new Date).toISOString()} [${e.toUpperCase()}] - ${t}`;"error"===e?console.error(n):console.log(n)}debug(t){this.logger(t,"debug")}error(t){this.logger(t,"error")}};e(s,"instance");let a=s;const u=t=>({ok:!0,value:t}),c=t=>({ok:!1,error:t});const l=t=>(...e)=>{try{return{ok:!0,value:t(...e)}}catch(n){return{ok:!1,error:n}}},f=a.getInstance(),d=class t{constructor(t){e(this,"handleError"),e(this,"customized",!1),t?(this.handleError=t,this.customized=!0):this.handleError=t=>a.getInstance().error(JSON.stringify(t))}static getInstance(){return t.instance||(t.instance=new t),t.instance}static init(e){this.initialized=!0,t.instance=new t(e)}printStatus(){f.debug("Custom error handler: "+(this.customized?"yes":"no"))}handle(t){console.warn("ðŸ§± Formbricks - Global error: ",t),this.handleError(t)}};e(d,"instance"),e(d,"initialized",!1);let h=d;const p=class t{constructor(){e(this,"config",null);const t=this.loadFromLocalStorage();t.ok&&(this.config=t.value)}static getInstance(){return t.instance||(t.instance=new t),t.instance}update(t){var e,n;t&&(this.config={...this.config,...t,status:{value:(null==(e=t.status)?void 0:e.value)||"success",expiresAt:(null==(n=t.status)?void 0:n.expiresAt)||null}},this.saveToStorage())}get(){if(!this.config)throw new Error("config is null, maybe the init function was not called?");return this.config}loadFromLocalStorage(){var t;if("undefined"!=typeof window){const e=localStorage.getItem(n);if(e){const n=JSON.parse(e);return(null==(t=n.environmentState)?void 0:t.expiresAt)&&new Date(n.environmentState.expiresAt)<=new Date?c(new Error("Config in local storage has expired")):u(n)}}return c(new Error("No or invalid config in local storage"))}async saveToStorage(){return l((async()=>{await localStorage.setItem(n,JSON.stringify(this.config))}))()}async resetConfig(){return this.config=null,l((async()=>{localStorage.removeItem(n)}))()}};e(p,"instance");let g=p;var y=Object.defineProperty,w=(t,e,n)=>((t,e,n)=>e in t?y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);const m=t=>({ok:!1,error:t}),v=async(t,e,n,r)=>{const i=new URL(t+e),o=r?JSON.stringify(r):void 0,s=await(a=fetch,async(...t)=>{try{return{ok:!0,data:await a(...t)}}catch(e){return{ok:!1,error:e}}})(i.toString(),{method:n,headers:{"Content-Type":"application/json"},body:o});var a;if(!s.ok)return m(s.error);const u=s.data,c=await u.json();if(!u.ok){const t=c;return m({code:"network_error",status:u.status,message:t.message||"Something went wrong",url:i,...Object.keys(t.details).length>0&&{details:t.details}})}return(t=>({ok:!0,data:t}))(c.data)};class b{constructor(t,e){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=t,this.environmentId=e}async update(t){const e={};for(const n in t.attributes)e[n]=String(t.attributes[n]);return v(this.apiHost,`/api/v1/client/${this.environmentId}/people/${t.userId}/attributes`,"PUT",{attributes:e})}}class I{constructor(t,e){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=t,this.environmentId=e}async create(t){return v(this.apiHost,`/api/v1/client/${this.environmentId}/displays`,"POST",t)}}class S{constructor(t,e){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=t,this.environmentId=e}async create(t){return v(this.apiHost,`/api/v1/client/${this.environmentId}/people`,"POST",{environmentId:this.environmentId,userId:t})}}class E{constructor(t,e){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=t,this.environmentId=e}async create(t){return v(this.apiHost,`/api/v1/client/${this.environmentId}/responses`,"POST",t)}async update({responseId:t,finished:e,data:n,ttc:r,variables:i,language:o}){return v(this.apiHost,`/api/v1/client/${this.environmentId}/responses/${t}`,"PUT",{finished:e,data:n,ttc:r,variables:i,language:o})}}for(var k={},B={byteLength:function(t){var e=T(t),n=e[0],r=e[1];return 3*(n+r)/4-r},toByteArray:function(t){var e,n,r=T(t),i=r[0],o=r[1],s=new R(function(t,e,n){return 3*(e+n)/4-n}(0,i,o)),a=0,u=o>0?i-4:i;for(n=0;n<u;n+=4)e=C[t.charCodeAt(n)]<<18|C[t.charCodeAt(n+1)]<<12|C[t.charCodeAt(n+2)]<<6|C[t.charCodeAt(n+3)],s[a++]=e>>16&255,s[a++]=e>>8&255,s[a++]=255&e;2===o&&(e=C[t.charCodeAt(n)]<<2|C[t.charCodeAt(n+1)]>>4,s[a++]=255&e);1===o&&(e=C[t.charCodeAt(n)]<<10|C[t.charCodeAt(n+1)]<<4|C[t.charCodeAt(n+2)]>>2,s[a++]=e>>8&255,s[a++]=255&e);return s},fromByteArray:function(t){for(var e,n=t.length,r=n%3,i=[],o=16383,s=0,a=n-r;s<a;s+=o)i.push(L(t,s,s+o>a?a:s+o));1===r?(e=t[n-1],i.push(A[e>>2]+A[e<<4&63]+"==")):2===r&&(e=(t[n-2]<<8)+t[n-1],i.push(A[e>>10]+A[e>>4&63]+A[e<<2&63]+"="));return i.join("")}},A=[],C=[],R="undefined"!=typeof Uint8Array?Uint8Array:Array,O="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",U=0;U<64;++U)A[U]=O[U],C[O.charCodeAt(U)]=U;function T(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");return-1===n&&(n=e),[n,n===e?0:4-n%4]}function L(t,e,n){for(var r,i,o=[],s=e;s<n;s+=3)r=(t[s]<<16&16711680)+(t[s+1]<<8&65280)+(255&t[s+2]),o.push(A[(i=r)>>18&63]+A[i>>12&63]+A[i>>6&63]+A[63&i]);return o.join("")}C["-".charCodeAt(0)]=62,C["_".charCodeAt(0)]=63;var $={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(t,e,n,r,i){var o,s,a=8*i-r-1,u=(1<<a)-1,c=u>>1,l=-7,f=n?i-1:0,d=n?-1:1,h=t[e+f];for(f+=d,o=h&(1<<-l)-1,h>>=-l,l+=a;l>0;o=256*o+t[e+f],f+=d,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=r;l>0;s=256*s+t[e+f],f+=d,l-=8);if(0===o)o=1-c;else{if(o===u)return s?NaN:1/0*(h?-1:1);s+=Math.pow(2,r),o-=c}return(h?-1:1)*s*Math.pow(2,o-r)},write:function(t,e,n,r,i,o){var s,a,u,c=8*o-i-1,l=(1<<c)-1,f=l>>1,d=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:o-1,p=r?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=l):(s=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-s))<1&&(s--,u*=2),(e+=s+f>=1?d/u:d*Math.pow(2,1-f))*u>=2&&(s++,u/=2),s+f>=l?(a=0,s=l):s+f>=1?(a=(e*u-1)*Math.pow(2,i),s+=f):(a=e*Math.pow(2,f-1)*Math.pow(2,i),s=0));i>=8;t[n+h]=255&a,h+=p,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;t[n+h]=255&s,h+=p,s/=256,c-=8);t[n+h-p]|=128*g}};
/*!
   * The buffer module from node.js, for the browser.
   *
   * @author   Feross Aboukhadijeh <https://feross.org>
   * @license  MIT
   */
!function(t){const e=B,n=$,r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=function(t){+t!=t&&(t=0);return c.alloc(+t)},t.INSPECT_MAX_BYTES=50;const i=2147483647;t.kMaxLength=i;const{Uint8Array:o,ArrayBuffer:s,SharedArrayBuffer:a}=globalThis;function u(t){if(t>i)throw new RangeError('The value "'+t+'" is invalid for option "size"');const e=new o(t);return Object.setPrototypeOf(e,c.prototype),e}function c(t,e,n){if("number"==typeof t){if("string"==typeof e)throw new TypeError('The "string" argument must be of type string. Received type number');return d(t)}return l(t,e,n)}function l(t,e,n){if("string"==typeof t)return function(t,e){"string"==typeof e&&""!==e||(e="utf8");if(!c.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const n=0|y(t,e);let r=u(n);const i=r.write(t,e);i!==n&&(r=r.slice(0,i));return r}(t,e);if(s.isView(t))return function(t){if(Z(t,o)){const e=new o(t);return p(e.buffer,e.byteOffset,e.byteLength)}return h(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(Z(t,s)||t&&Z(t.buffer,s))return p(t,e,n);if(void 0!==a&&(Z(t,a)||t&&Z(t.buffer,a)))return p(t,e,n);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=t.valueOf&&t.valueOf();if(null!=r&&r!==t)return c.from(r,e,n);const i=function(t){if(c.isBuffer(t)){const e=0|g(t.length),n=u(e);return 0===n.length||t.copy(n,0,0,e),n}if(void 0!==t.length)return"number"!=typeof t.length||K(t.length)?u(0):h(t);if("Buffer"===t.type&&Array.isArray(t.data))return h(t.data)}(t);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return c.from(t[Symbol.toPrimitive]("string"),e,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function f(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function d(t){return f(t),u(t<0?0:0|g(t))}function h(t){const e=t.length<0?0:0|g(t.length),n=u(e);for(let r=0;r<e;r+=1)n[r]=255&t[r];return n}function p(t,e,n){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(n||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===e&&void 0===n?new o(t):void 0===n?new o(t,e):new o(t,e,n),Object.setPrototypeOf(r,c.prototype),r}function g(t){if(t>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|t}function y(t,e){if(c.isBuffer(t))return t.length;if(s.isView(t)||Z(t,s))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);const n=t.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;let i=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return W(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return V(t).length;default:if(i)return r?-1:W(t).length;e=(""+e).toLowerCase(),i=!0}}function w(t,e,n){let r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return L(this,e,n);case"utf8":case"utf-8":return R(this,e,n);case"ascii":return U(this,e,n);case"latin1":case"binary":return T(this,e,n);case"base64":return C(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return F(this,e,n);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}function m(t,e,n){const r=t[e];t[e]=t[n],t[n]=r}function v(t,e,n,r,i){if(0===t.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),K(n=+n)&&(n=i?0:t.length-1),n<0&&(n=t.length+n),n>=t.length){if(i)return-1;n=t.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof e&&(e=c.from(e,r)),c.isBuffer(e))return 0===e.length?-1:b(t,e,n,r,i);if("number"==typeof e)return e&=255,"function"==typeof o.prototype.indexOf?i?o.prototype.indexOf.call(t,e,n):o.prototype.lastIndexOf.call(t,e,n):b(t,[e],n,r,i);throw new TypeError("val must be string, number or Buffer")}function b(t,e,n,r,i){let o,s=1,a=t.length,u=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;s=2,a/=2,u/=2,n/=2}function c(t,e){return 1===s?t[e]:t.readUInt16BE(e*s)}if(i){let r=-1;for(o=n;o<a;o++)if(c(t,o)===c(e,-1===r?0:o-r)){if(-1===r&&(r=o),o-r+1===u)return r*s}else-1!==r&&(o-=o-r),r=-1}else for(n+u>a&&(n=a-u),o=n;o>=0;o--){let n=!0;for(let r=0;r<u;r++)if(c(t,o+r)!==c(e,r)){n=!1;break}if(n)return o}return-1}function I(t,e,n,r){n=Number(n)||0;const i=t.length-n;r?(r=Number(r))>i&&(r=i):r=i;const o=e.length;let s;for(r>o/2&&(r=o/2),s=0;s<r;++s){const r=parseInt(e.substr(2*s,2),16);if(K(r))return s;t[n+s]=r}return s}function S(t,e,n,r){return Q(W(e,t.length-n),t,n,r)}function E(t,e,n,r){return Q(function(t){const e=[];for(let n=0;n<t.length;++n)e.push(255&t.charCodeAt(n));return e}(e),t,n,r)}function k(t,e,n,r){return Q(V(e),t,n,r)}function A(t,e,n,r){return Q(function(t,e){let n,r,i;const o=[];for(let s=0;s<t.length&&!((e-=2)<0);++s)n=t.charCodeAt(s),r=n>>8,i=n%256,o.push(i),o.push(r);return o}(e,t.length-n),t,n,r)}function C(t,n,r){return 0===n&&r===t.length?e.fromByteArray(t):e.fromByteArray(t.slice(n,r))}function R(t,e,n){n=Math.min(t.length,n);const r=[];let i=e;for(;i<n;){const e=t[i];let o=null,s=e>239?4:e>223?3:e>191?2:1;if(i+s<=n){let n,r,a,u;switch(s){case 1:e<128&&(o=e);break;case 2:n=t[i+1],128==(192&n)&&(u=(31&e)<<6|63&n,u>127&&(o=u));break;case 3:n=t[i+1],r=t[i+2],128==(192&n)&&128==(192&r)&&(u=(15&e)<<12|(63&n)<<6|63&r,u>2047&&(u<55296||u>57343)&&(o=u));break;case 4:n=t[i+1],r=t[i+2],a=t[i+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&(u=(15&e)<<18|(63&n)<<12|(63&r)<<6|63&a,u>65535&&u<1114112&&(o=u))}}null===o?(o=65533,s=1):o>65535&&(o-=65536,r.push(o>>>10&1023|55296),o=56320|1023&o),r.push(o),i+=s}return function(t){const e=t.length;if(e<=O)return String.fromCharCode.apply(String,t);let n="",r=0;for(;r<e;)n+=String.fromCharCode.apply(String,t.slice(r,r+=O));return n}(r)}c.TYPED_ARRAY_SUPPORT=function(){try{const t=new o(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,o.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch(t){return!1}}(),c.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}}),c.poolSize=8192,c.from=function(t,e,n){return l(t,e,n)},Object.setPrototypeOf(c.prototype,o.prototype),Object.setPrototypeOf(c,o),c.alloc=function(t,e,n){return function(t,e,n){return f(t),t<=0?u(t):void 0!==e?"string"==typeof n?u(t).fill(e,n):u(t).fill(e):u(t)}(t,e,n)},c.allocUnsafe=function(t){return d(t)},c.allocUnsafeSlow=function(t){return d(t)},c.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==c.prototype},c.compare=function(t,e){if(Z(t,o)&&(t=c.from(t,t.offset,t.byteLength)),Z(e,o)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(t)||!c.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let n=t.length,r=e.length;for(let i=0,o=Math.min(n,r);i<o;++i)if(t[i]!==e[i]){n=t[i],r=e[i];break}return n<r?-1:r<n?1:0},c.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return c.alloc(0);let n;if(void 0===e)for(e=0,n=0;n<t.length;++n)e+=t[n].length;const r=c.allocUnsafe(e);let i=0;for(n=0;n<t.length;++n){let e=t[n];if(Z(e,o))i+e.length>r.length?(c.isBuffer(e)||(e=c.from(e)),e.copy(r,i)):o.prototype.set.call(r,e,i);else{if(!c.isBuffer(e))throw new TypeError('"list" argument must be an Array of Buffers');e.copy(r,i)}i+=e.length}return r},c.byteLength=y,c.prototype._isBuffer=!0,c.prototype.swap16=function(){const t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)m(this,e,e+1);return this},c.prototype.swap32=function(){const t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)m(this,e,e+3),m(this,e+1,e+2);return this},c.prototype.swap64=function(){const t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)m(this,e,e+7),m(this,e+1,e+6),m(this,e+2,e+5),m(this,e+3,e+4);return this},c.prototype.toString=function(){const t=this.length;return 0===t?"":0===arguments.length?R(this,0,t):w.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(t){if(!c.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===c.compare(this,t)},c.prototype.inspect=function(){let e="";const n=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(e+=" ... "),"<Buffer "+e+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(t,e,n,r,i){if(Z(t,o)&&(t=c.from(t,t.offset,t.byteLength)),!c.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===n&&(n=t?t.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),e<0||n>t.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&e>=n)return 0;if(r>=i)return-1;if(e>=n)return 1;if(this===t)return 0;let s=(i>>>=0)-(r>>>=0),a=(n>>>=0)-(e>>>=0);const u=Math.min(s,a),l=this.slice(r,i),f=t.slice(e,n);for(let o=0;o<u;++o)if(l[o]!==f[o]){s=l[o],a=f[o];break}return s<a?-1:a<s?1:0},c.prototype.includes=function(t,e,n){return-1!==this.indexOf(t,e,n)},c.prototype.indexOf=function(t,e,n){return v(this,t,e,n,!0)},c.prototype.lastIndexOf=function(t,e,n){return v(this,t,e,n,!1)},c.prototype.write=function(t,e,n,r){if(void 0===e)r="utf8",n=this.length,e=0;else if(void 0===n&&"string"==typeof e)r=e,n=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}const i=this.length-e;if((void 0===n||n>i)&&(n=i),t.length>0&&(n<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let o=!1;for(;;)switch(r){case"hex":return I(this,t,e,n);case"utf8":case"utf-8":return S(this,t,e,n);case"ascii":case"latin1":case"binary":return E(this,t,e,n);case"base64":return k(this,t,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,t,e,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const O=4096;function U(t,e,n){let r="";n=Math.min(t.length,n);for(let i=e;i<n;++i)r+=String.fromCharCode(127&t[i]);return r}function T(t,e,n){let r="";n=Math.min(t.length,n);for(let i=e;i<n;++i)r+=String.fromCharCode(t[i]);return r}function L(t,e,n){const r=t.length;(!e||e<0)&&(e=0),(!n||n<0||n>r)&&(n=r);let i="";for(let o=e;o<n;++o)i+=tt[t[o]];return i}function F(t,e,n){const r=t.slice(e,n);let i="";for(let o=0;o<r.length-1;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function H(t,e,n){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>n)throw new RangeError("Trying to access beyond buffer length")}function x(t,e,n,r,i,o){if(!c.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>i||e<o)throw new RangeError('"value" argument is out of bounds');if(n+r>t.length)throw new RangeError("Index out of range")}function P(t,e,n,r,i){J(e,r,i,t,n,7);let o=Number(e&BigInt(4294967295));t[n++]=o,o>>=8,t[n++]=o,o>>=8,t[n++]=o,o>>=8,t[n++]=o;let s=Number(e>>BigInt(32)&BigInt(4294967295));return t[n++]=s,s>>=8,t[n++]=s,s>>=8,t[n++]=s,s>>=8,t[n++]=s,n}function D(t,e,n,r,i){J(e,r,i,t,n,7);let o=Number(e&BigInt(4294967295));t[n+7]=o,o>>=8,t[n+6]=o,o>>=8,t[n+5]=o,o>>=8,t[n+4]=o;let s=Number(e>>BigInt(32)&BigInt(4294967295));return t[n+3]=s,s>>=8,t[n+2]=s,s>>=8,t[n+1]=s,s>>=8,t[n]=s,n+8}function N(t,e,n,r,i,o){if(n+r>t.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function _(t,e,r,i,o){return e=+e,r>>>=0,o||N(t,0,r,4),n.write(t,e,r,i,23,4),r+4}function M(t,e,r,i,o){return e=+e,r>>>=0,o||N(t,0,r,8),n.write(t,e,r,i,52,8),r+8}c.prototype.slice=function(t,e){const n=this.length;(t=~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),(e=void 0===e?n:~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),e<t&&(e=t);const r=this.subarray(t,e);return Object.setPrototypeOf(r,c.prototype),r},c.prototype.readUintLE=c.prototype.readUIntLE=function(t,e,n){t>>>=0,e>>>=0,n||H(t,e,this.length);let r=this[t],i=1,o=0;for(;++o<e&&(i*=256);)r+=this[t+o]*i;return r},c.prototype.readUintBE=c.prototype.readUIntBE=function(t,e,n){t>>>=0,e>>>=0,n||H(t,e,this.length);let r=this[t+--e],i=1;for(;e>0&&(i*=256);)r+=this[t+--e]*i;return r},c.prototype.readUint8=c.prototype.readUInt8=function(t,e){return t>>>=0,e||H(t,1,this.length),this[t]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(t,e){return t>>>=0,e||H(t,2,this.length),this[t]|this[t+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(t,e){return t>>>=0,e||H(t,2,this.length),this[t]<<8|this[t+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(t,e){return t>>>=0,e||H(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(t,e){return t>>>=0,e||H(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},c.prototype.readBigUInt64LE=et((function(t){Y(t>>>=0,"offset");const e=this[t],n=this[t+7];void 0!==e&&void 0!==n||X(t,this.length-8);const r=e+256*this[++t]+65536*this[++t]+this[++t]*2**24,i=this[++t]+256*this[++t]+65536*this[++t]+n*2**24;return BigInt(r)+(BigInt(i)<<BigInt(32))})),c.prototype.readBigUInt64BE=et((function(t){Y(t>>>=0,"offset");const e=this[t],n=this[t+7];void 0!==e&&void 0!==n||X(t,this.length-8);const r=e*2**24+65536*this[++t]+256*this[++t]+this[++t],i=this[++t]*2**24+65536*this[++t]+256*this[++t]+n;return(BigInt(r)<<BigInt(32))+BigInt(i)})),c.prototype.readIntLE=function(t,e,n){t>>>=0,e>>>=0,n||H(t,e,this.length);let r=this[t],i=1,o=0;for(;++o<e&&(i*=256);)r+=this[t+o]*i;return i*=128,r>=i&&(r-=Math.pow(2,8*e)),r},c.prototype.readIntBE=function(t,e,n){t>>>=0,e>>>=0,n||H(t,e,this.length);let r=e,i=1,o=this[t+--r];for(;r>0&&(i*=256);)o+=this[t+--r]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*e)),o},c.prototype.readInt8=function(t,e){return t>>>=0,e||H(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},c.prototype.readInt16LE=function(t,e){t>>>=0,e||H(t,2,this.length);const n=this[t]|this[t+1]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt16BE=function(t,e){t>>>=0,e||H(t,2,this.length);const n=this[t+1]|this[t]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt32LE=function(t,e){return t>>>=0,e||H(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},c.prototype.readInt32BE=function(t,e){return t>>>=0,e||H(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},c.prototype.readBigInt64LE=et((function(t){Y(t>>>=0,"offset");const e=this[t],n=this[t+7];void 0!==e&&void 0!==n||X(t,this.length-8);const r=this[t+4]+256*this[t+5]+65536*this[t+6]+(n<<24);return(BigInt(r)<<BigInt(32))+BigInt(e+256*this[++t]+65536*this[++t]+this[++t]*2**24)})),c.prototype.readBigInt64BE=et((function(t){Y(t>>>=0,"offset");const e=this[t],n=this[t+7];void 0!==e&&void 0!==n||X(t,this.length-8);const r=(e<<24)+65536*this[++t]+256*this[++t]+this[++t];return(BigInt(r)<<BigInt(32))+BigInt(this[++t]*2**24+65536*this[++t]+256*this[++t]+n)})),c.prototype.readFloatLE=function(t,e){return t>>>=0,e||H(t,4,this.length),n.read(this,t,!0,23,4)},c.prototype.readFloatBE=function(t,e){return t>>>=0,e||H(t,4,this.length),n.read(this,t,!1,23,4)},c.prototype.readDoubleLE=function(t,e){return t>>>=0,e||H(t,8,this.length),n.read(this,t,!0,52,8)},c.prototype.readDoubleBE=function(t,e){return t>>>=0,e||H(t,8,this.length),n.read(this,t,!1,52,8)},c.prototype.writeUintLE=c.prototype.writeUIntLE=function(t,e,n,r){if(t=+t,e>>>=0,n>>>=0,!r){x(this,t,e,n,Math.pow(2,8*n)-1,0)}let i=1,o=0;for(this[e]=255&t;++o<n&&(i*=256);)this[e+o]=t/i&255;return e+n},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(t,e,n,r){if(t=+t,e>>>=0,n>>>=0,!r){x(this,t,e,n,Math.pow(2,8*n)-1,0)}let i=n-1,o=1;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=t/o&255;return e+n},c.prototype.writeUint8=c.prototype.writeUInt8=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,1,255,0),this[e]=255&t,e+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},c.prototype.writeBigUInt64LE=et((function(t,e=0){return P(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),c.prototype.writeBigUInt64BE=et((function(t,e=0){return D(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),c.prototype.writeIntLE=function(t,e,n,r){if(t=+t,e>>>=0,!r){const r=Math.pow(2,8*n-1);x(this,t,e,n,r-1,-r)}let i=0,o=1,s=0;for(this[e]=255&t;++i<n&&(o*=256);)t<0&&0===s&&0!==this[e+i-1]&&(s=1),this[e+i]=(t/o|0)-s&255;return e+n},c.prototype.writeIntBE=function(t,e,n,r){if(t=+t,e>>>=0,!r){const r=Math.pow(2,8*n-1);x(this,t,e,n,r-1,-r)}let i=n-1,o=1,s=0;for(this[e+i]=255&t;--i>=0&&(o*=256);)t<0&&0===s&&0!==this[e+i+1]&&(s=1),this[e+i]=(t/o|0)-s&255;return e+n},c.prototype.writeInt8=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},c.prototype.writeInt16LE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},c.prototype.writeInt16BE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},c.prototype.writeInt32LE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},c.prototype.writeInt32BE=function(t,e,n){return t=+t,e>>>=0,n||x(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},c.prototype.writeBigInt64LE=et((function(t,e=0){return P(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),c.prototype.writeBigInt64BE=et((function(t,e=0){return D(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),c.prototype.writeFloatLE=function(t,e,n){return _(this,t,e,!0,n)},c.prototype.writeFloatBE=function(t,e,n){return _(this,t,e,!1,n)},c.prototype.writeDoubleLE=function(t,e,n){return M(this,t,e,!0,n)},c.prototype.writeDoubleBE=function(t,e,n){return M(this,t,e,!1,n)},c.prototype.copy=function(t,e,n,r){if(!c.isBuffer(t))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-n&&(r=t.length-e+n);const i=r-n;return this===t&&"function"==typeof o.prototype.copyWithin?this.copyWithin(e,n,r):o.prototype.set.call(t,this.subarray(n,r),e),i},c.prototype.fill=function(t,e,n,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!c.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===t.length){const e=t.charCodeAt(0);("utf8"===r&&e<128||"latin1"===r)&&(t=e)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<n)throw new RangeError("Out of range index");if(n<=e)return this;let i;if(e>>>=0,n=void 0===n?this.length:n>>>0,t||(t=0),"number"==typeof t)for(i=e;i<n;++i)this[i]=t;else{const o=c.isBuffer(t)?t:c.from(t,r),s=o.length;if(0===s)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(i=0;i<n-e;++i)this[i+e]=o[i%s]}return this};const j={};function z(t,e,n){j[t]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(t){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:t,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}function q(t){let e="",n=t.length;const r="-"===t[0]?1:0;for(;n>=r+4;n-=3)e=`_${t.slice(n-3,n)}${e}`;return`${t.slice(0,n)}${e}`}function J(t,e,n,r,i,o){if(t>n||t<e){const n="bigint"==typeof e?"n":"";let r;throw r=0===e||e===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(o+1)}${n}`:`>= -(2${n} ** ${8*(o+1)-1}${n}) and < 2 ** ${8*(o+1)-1}${n}`,new j.ERR_OUT_OF_RANGE("value",r,t)}!function(t,e,n){Y(e,"offset"),void 0!==t[e]&&void 0!==t[e+n]||X(e,t.length-(n+1))}(r,i,o)}function Y(t,e){if("number"!=typeof t)throw new j.ERR_INVALID_ARG_TYPE(e,"number",t)}function X(t,e,n){if(Math.floor(t)!==t)throw Y(t,n),new j.ERR_OUT_OF_RANGE("offset","an integer",t);if(e<0)throw new j.ERR_BUFFER_OUT_OF_BOUNDS;throw new j.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,t)}z("ERR_BUFFER_OUT_OF_BOUNDS",(function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),z("ERR_INVALID_ARG_TYPE",(function(t,e){return`The "${t}" argument must be of type number. Received type ${typeof e}`}),TypeError),z("ERR_OUT_OF_RANGE",(function(t,e,n){let r=`The value of "${t}" is out of range.`,i=n;return Number.isInteger(n)&&Math.abs(n)>2**32?i=q(String(n)):"bigint"==typeof n&&(i=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(i=q(i)),i+="n"),r+=` It must be ${e}. Received ${i}`,r}),RangeError);const G=/[^+/0-9A-Za-z-_]/g;function W(t,e){let n;e=e||1/0;const r=t.length;let i=null;const o=[];for(let s=0;s<r;++s){if(n=t.charCodeAt(s),n>55295&&n<57344){if(!i){if(n>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(e-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(e-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(e-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((e-=1)<0)break;o.push(n)}else if(n<2048){if((e-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((e-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function V(t){return e.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function Q(t,e,n,r){let i;for(i=0;i<r&&!(i+n>=e.length||i>=t.length);++i)e[i+n]=t[i];return i}function Z(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function K(t){return t!=t}const tt=function(){const t="0123456789abcdef",e=new Array(256);for(let n=0;n<16;++n){const r=16*n;for(let i=0;i<16;++i)e[r+i]=t[n]+t[i]}return e}();function et(t){return"undefined"==typeof BigInt?nt:t}function nt(){throw new Error("BigInt not supported")}}(k);const F=k.Buffer;class H{constructor(t,e){w(this,"apiHost"),w(this,"environmentId"),this.apiHost=t,this.environmentId=e}async uploadFile(t,{allowedFileExtensions:e,surveyId:n}={}){if(!t.name||!t.type||!t.base64)throw new Error("Invalid file object");const r={fileName:t.name,fileType:t.type,allowedFileExtensions:e,surveyId:n},i=await fetch(`${this.apiHost}/api/v1/client/${this.environmentId}/storage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok)throw new Error(`Upload failed with status: ${String(i.status)}`);const o=await i.json(),{data:s}=o,{signedUrl:a,fileUrl:u,signingData:c,presignedFields:l,updatedFileName:f}=s;let d={};if(c){const{signature:e,timestamp:r,uuid:i}=c;d={"X-File-Type":t.type,"X-File-Name":encodeURIComponent(f),"X-Survey-ID":n??"","X-Signature":e,"X-Timestamp":String(r),"X-UUID":i}}const h={},p=new FormData;if(l){Object.keys(l).forEach((t=>{p.append(t,l[t])}));try{const e=F.from(t.base64.split(",")[1],"base64"),n=new Blob([e],{type:t.type});p.append("file",n)}catch(w){throw console.error({buffErr:w}),new Error("Error uploading file")}}h.fileBase64String=t.base64;let g={};const y=a.replace("http://localhost:3000",this.apiHost);try{g=await fetch(y,{method:"POST",...c?{headers:{...d}}:{},body:l?p:JSON.stringify(h)})}catch(m){console.error("Error uploading file",m)}if(!g.ok){if(c){const t=await g.json(),e=new Error(t.message);throw e.name="FileTooLargeError",e}const t=await g.text();if(l&&t.includes("EntityTooLarge")){const t=new Error("File size exceeds the size limit for your plan");throw t.name="FileTooLargeError",t}throw new Error(`Upload failed with status: ${String(g.status)}`)}return u}}class x{constructor(t){w(this,"response"),w(this,"display"),w(this,"people"),w(this,"storage"),w(this,"attribute");const{apiHost:e,environmentId:n}=t;this.response=new E(e,n),this.display=new I(e,n),this.people=new S(e,n),this.attribute=new b(e,n),this.storage=new H(e,n)}}class P{constructor(t){w(this,"client"),this.client=new x(t)}}const D=t=>new Promise((e=>setTimeout(e,t)));class N{constructor(t,n){e(this,"queue",[]),e(this,"config"),e(this,"surveyState"),e(this,"isRequestInProgress",!1),e(this,"api"),this.config=t,this.surveyState=n,this.api=new P({apiHost:t.apiHost,environmentId:t.environmentId})}add(t){this.surveyState.accumulateResponse(t),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState),this.queue.push(t),this.processQueue()}async processQueue(){if(this.isRequestInProgress)return;if(0===this.queue.length)return;this.isRequestInProgress=!0;const t=this.queue[0];let e=0;for(;e<this.config.retryAttempts;){if(await this.sendResponse(t)){this.queue.shift();break}console.error(`Formbricks: Failed to send response. Retrying... ${e}`),await D(1e3),e++}e>=this.config.retryAttempts?(console.error("Failed to send response after 2 attempts."),this.config.onResponseSendingFailed&&this.config.onResponseSendingFailed(t),this.isRequestInProgress=!1):(t.finished&&this.config.onResponseSendingFinished&&this.config.onResponseSendingFinished(),this.isRequestInProgress=!1,this.processQueue())}async sendResponse(t){try{if(null!==this.surveyState.responseId)await this.api.client.response.update({...t,responseId:this.surveyState.responseId});else{const e=await this.api.client.response.create({...t,surveyId:this.surveyState.surveyId,userId:this.surveyState.userId||null,singleUseId:this.surveyState.singleUseId||null,data:{...t.data,...t.hiddenFields},displayId:this.surveyState.displayId});if(!e.ok)throw new Error("Could not create response");this.surveyState.updateResponseId(e.data.id),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState)}return!0}catch(e){return console.error(e),!1}}updateSurveyState(t){this.surveyState=t}}class _{constructor(t,n,r,i){e(this,"responseId",null),e(this,"displayId",null),e(this,"userId",null),e(this,"surveyId"),e(this,"responseAcc",{finished:!1,data:{},ttc:{},variables:{}}),e(this,"singleUseId"),this.surveyId=t,this.userId=i??null,this.singleUseId=n??null,this.responseId=r??null}setSurveyId(t){this.surveyId=t,this.clear()}copy(){const t=new _(this.surveyId,this.singleUseId??void 0,this.responseId??void 0,this.userId??void 0);return t.responseId=this.responseId,t.responseAcc=this.responseAcc,t}updateResponseId(t){this.responseId=t}updateDisplayId(t){this.displayId=t}updateUserId(t){this.userId=t}accumulateResponse(t){this.responseAcc={finished:t.finished,ttc:t.ttc,data:{...this.responseAcc.data,...t.data},variables:t.variables,displayId:t.displayId}}isResponseFinished(){return this.responseAcc.finished}clear(){this.responseId=null,this.responseAcc={finished:!1,data:{},ttc:{},variables:{}}}}const M=(t,e)=>{var n;return t.styling.allowStyleOverwrite&&t.styling.allowStyleOverwrite&&(null==(n=e.styling)?void 0:n.overwriteThemeStyling)?e.styling:t.styling},j=(t,e)=>{const n=Math.abs(e.getTime()-t.getTime());return Math.floor(n/864e5)},z=a.getInstance(),q=t=>{if(!t||0===t.length)return!0;const e=window.location.href;return t.some((t=>((t,e,n)=>{switch(n){case"exactMatch":return t===e;case"contains":return t.includes(e);case"startsWith":return t.startsWith(e);case"endsWith":return t.endsWith(e);case"notMatch":return t!==e;case"notContains":return!t.includes(e);default:return!1}})(e,t.value,t.rule)))},J=t=>{var e;const n=null==(e=t.languages)?void 0:e.find((t=>!0===t.default));if(n)return n.language.code},Y=()=>window.location.search.includes("formbricksDebug=true"),X=(t,e)=>{const{product:n,surveys:r}=t.data,{displays:i,responses:o,lastDisplayAt:s,segments:a,userId:u}=e.data;if(!i)return[];let c=r.filter((t=>{switch(t.displayOption){case"respondMultiple":return!0;case"displayOnce":return 0===i.filter((e=>e.surveyId===t.id)).length;case"displayMultiple":return 0===o.filter((e=>e===t.id)).length;case"displaySome":return null===t.displayLimit||!o.filter((e=>e===t.id)).length&&i.filter((e=>e.surveyId===t.id)).length<t.displayLimit;default:throw Error("Invalid displayOption")}}));return c=c.filter((t=>{if(s){if(null!==t.recontactDays){const e=i.filter((e=>e.surveyId===t.id))[0];return!e||j(new Date,new Date(e.createdAt))>=t.recontactDays}return null===n.recontactDays||j(new Date,new Date(s))>=n.recontactDays}return!0})),u?a.length?c.filter((t=>{var e;return(null==(e=t.segment)?void 0:e.id)&&a.includes(t.segment.id)})):[]:c},G=g.getInstance(),W=a.getInstance();let V=!1,Q=t=>{},Z=t=>{};const K=t=>{V=t},tt=async(t,e,n)=>{if(t.displayPercentage){if(!(r=t.displayPercentage,Math.floor(1e4*Math.random())/100<=r))return void W.debug(`Survey display of "${t.name}" skipped based on displayPercentage.`)}var r;const i=((t,e)=>{const{enabled:n,fieldIds:r}=t||{};let i={};if(n){if(r&&e){const t=[];i=Object.keys(e).reduce(((n,i)=>((null==r?void 0:r.includes(i))?n[i]=null==e?void 0:e[i]:t.push(i),n)),{}),t.length>0&&z.error(`Unknown hidden fields: ${t.join(", ")}. Please add them to the survey hidden fields.`)}}else z.error("Hidden fields are not enabled for this survey");return i})(t.hiddenFields,null==n?void 0:n.hiddenFields);await et(t,e,i)},et=async(t,e,n={})=>{if(V)return void W.debug("A survey is already running. Skipping.");K(!0),t.delay&&W.debug(`Delaying survey "${t.name}" by ${t.delay} seconds.`);const{product:r}=G.get().environmentState.data??{},{attributes:i}=G.get().personState.data??{},o=t.languages.length>1;let s="default";if(o){const e=((t,e)=>{const n=e.language,r=t.languages.map((t=>t.language.code));if(n){const e=t.languages.find((t=>{var e;return t.language.code===n.toLowerCase()||(null==(e=t.language.alias)?void 0:e.toLowerCase())===n.toLowerCase()}));if(null==e?void 0:e.default)return"default";if(!e||!(null==e?void 0:e.enabled)||!r.includes(e.language.code))return;return e.language.code}return"default"})(t,i);if(!e)return W.debug(`Survey "${t.name}" is not available in specified language.`),void K(!0);s=e}const a=new _(t.id,null,null,G.get().personState.data.userId),u=new N({apiHost:G.get().apiHost,environmentId:G.get().environmentId,retryAttempts:2,onResponseSendingFailed:()=>{Q(!0)},onResponseSendingFinished:()=>{Z(!0)}},a),c=t.productOverwrites??{},l=c.clickOutsideClose??r.clickOutsideClose,f=c.darkOverlay??r.darkOverlay,d=c.placement??r.placement,h=r.inAppSurveyBranding,p=await ot();setTimeout((()=>{p.renderSurveyModal({survey:t,isBrandingEnabled:h,clickOutside:l,darkOverlay:f,languageCode:s,placement:d,styling:M(r,t),getSetIsError:t=>{Q=t},getSetIsResponseSendingFinished:t=>{Z=t},onDisplay:async()=>{const{userId:e}=G.get().personState.data,n=new P({apiHost:G.get().apiHost,environmentId:G.get().environmentId}),r=await n.client.display.create({surveyId:t.id,...e&&{userId:e}});if(!r.ok)throw new Error("Could not create display");const{id:i}=r.data;a.updateDisplayId(i),u.updateSurveyState(a);const o=G.get().personState.data.displays,s={surveyId:t.id,createdAt:new Date},c=o?[...o,s]:[s],l=G.get(),f={...l.personState,data:{...l.personState.data,displays:c,lastDisplayAt:new Date}},d=X(l.environmentState,f);G.update({...l,environmentState:l.environmentState,personState:f,filteredSurveys:d})},onResponse:r=>{const{userId:i}=G.get().personState.data,o=null===a.responseId;if(i&&a.updateUserId(i),u.updateSurveyState(a),u.add({data:r.data,ttc:r.ttc,finished:r.finished,language:"default"===r.language?J(t):r.language,meta:{url:window.location.href,action:e},variables:r.variables,hiddenFields:n,displayId:a.displayId}),o){const t=G.get().personState.data.responses,e={...G.get().personState,data:{...G.get().personState.data,responses:[...t,a.surveyId]}},n=X(G.get().environmentState,e);G.update({...G.get(),environmentState:G.get().environmentState,personState:e,filteredSurveys:n})}},onClose:nt,onFileUpload:async(t,e)=>{const n=new P({apiHost:G.get().apiHost,environmentId:G.get().environmentId});return await n.client.storage.uploadFile({type:t.type,name:t.name,base64:t.base64},e)},onRetry:()=>{Q(!1),u.processQueue()},hiddenFieldsRecord:n})}),1e3*t.delay)},nt=async()=>{it(),rt();const{environmentState:t,personState:e}=G.get(),n=X(t,e);G.update({...G.get(),environmentState:t,personState:e,filteredSurveys:n}),K(!1)},rt=()=>{const t=document.createElement("div");t.id=o,document.body.appendChild(t)},it=()=>{var t;null==(t=document.getElementById(o))||t.remove()},ot=()=>new Promise(((t,e)=>{if(window.formbricksSurveys)t(window.formbricksSurveys);else{const n=document.createElement("script");n.src=`${G.get().apiHost}/api/packages/surveys`,n.async=!0,n.onload=()=>t(window.formbricksSurveys),n.onerror=t=>{console.error("Failed to load Formbricks Surveys library:",t),e(t)},document.head.appendChild(n)}})),st=a.getInstance(),at=g.getInstance(),ut=async(t,e,n)=>{const r=e||t;st.debug(`Formbricks: Action "${r}" tracked`);const i=at.get().filteredSurveys;if(i&&i.length>0)for(const o of i)for(const e of o.triggers)e.actionClass.name===t&&await tt(o,t,n);else st.debug("No active surveys to display");return{ok:!0,value:void 0}},ct=(t,e)=>{const n=at.get().environmentState.data.actionClasses.filter((t=>"code"===t.type)).find((e=>e.key===t));return n?ut(n.name,t,e):c({code:"invalid_code",message:`${t} action unknown. Please add this action in Formbricks first in order to use it in your code.`})},lt=t=>ut(t),ft=g.getInstance(),dt=a.getInstance();let ht=null;const pt={expiresAt:null,data:{userId:null,segments:[],displays:[],responses:[],attributes:{},lastDisplayAt:null}},gt=async({apiHost:t,environmentId:e,userId:n},r=!1)=>{let i={};(r||Y())&&(i.cache="no-cache",dt.debug("No cache option set for sync"));const o=`${t}/api/v1/client/${e}/identify/people/${n}`,s=await fetch(o,i);if(!s.ok){const t=await s.json();throw c({code:"network_error",status:s.status,message:"Error syncing with backend",url:new URL(o),responseMessage:t.message})}const a=await s.json(),{data:u}=a;console.log("Person state fetched",u);const l={expiresAt:new Date((new Date).getTime()+18e5),data:{userId:n,segments:[],displays:[],responses:[],attributes:{},lastDisplayAt:null}};return Object.keys(u).length?{data:{...u},expiresAt:new Date((new Date).getTime()+18e5)}:l},yt=()=>{ht&&(clearInterval(ht),ht=null)},wt=g.getInstance(),mt=a.getInstance(),vt=async(t,e)=>{if("userId"===t)return mt.error("Setting userId is no longer supported. Please set the userId in the init call instead."),{ok:!0,value:void 0};const n=wt.get().personState.data.userId;if(mt.debug("Setting attribute: "+t+" to value: "+e),((t,e)=>wt.get().personState.data.attributes[t]===e)(t,e.toString()))return mt.debug("Attribute already set to this value. Skipping update."),{ok:!0,value:void 0};if(!n)return mt.error("UserId not provided, please provide a userId in the init method before setting attributes."),{ok:!0,value:void 0};const r=await(async(t,e)=>{var n;const{apiHost:r,environmentId:i}=wt.get(),o=wt.get().personState.data.userId;if(!o)return c({code:"network_error",status:500,message:"Missing userId",url:`${r}/api/v1/client/${i}/people/${o}/attributes`,responseMessage:"Missing userId"});const s=new P({apiHost:r,environmentId:i}),a=await s.client.attribute.update({userId:o,attributes:{[t]:e}});return a.ok?a.data.changed?(mt.debug("Attribute updated in Formbricks"),{ok:!0,value:{changed:!0,message:"Attribute updated in Formbricks"}}):{ok:!0,value:{changed:!1,message:"Attribute not updated in Formbricks"}}:(null==(n=a.error.details)?void 0:n.ignore)?(mt.error(a.error.message??`Error updating person with userId ${o}`),{ok:!0,value:{changed:!1,message:a.error.message}}):c({code:"network_error",status:a.error.status??500,message:a.error.message??`Error updating person with userId ${o}`,url:`${wt.get().apiHost}/api/v1/client/${i}/people/${o}/attributes`,responseMessage:a.error.message})})(t,e.toString());if(r.ok){if(r.value.changed){const t=await gt({apiHost:wt.get().apiHost,environmentId:wt.get().environmentId,userId:n},!0),e=X(wt.get().environmentState,t);wt.update({...wt.get(),personState:t,filteredSurveys:e})}return{ok:!0,value:void 0}}return c(r.error)},bt=t=>async(...e)=>{try{return{ok:!0,data:await t(...e)}}catch(n){return{ok:!1,error:n}}},It=g.getInstance(),St=a.getInstance();let Et=null;const kt=async({apiHost:t,environmentId:e},n=!1)=>{let r={};(n||Y())&&(r.cache="no-cache",St.debug("No cache option set for sync"));const i=`${t}/api/v1/client/${e}/environment`,o=await fetch(i,r);if(!o.ok){const t=await o.json();throw c({code:"network_error",status:o.status,message:"Error syncing with backend",url:new URL(i),responseMessage:t.message})}const s=await o.json(),{data:a}=s;return{data:{...a},expiresAt:new Date((new Date).getTime()+18e5)}},Bt=()=>{Et&&(clearInterval(Et),Et=null)},At=g.getInstance(),Ct=a.getInstance(),Rt=h.getInstance(),Ot=["hashchange","popstate","pushstate","replacestate","load"];let Ut=!1;const Tt=async()=>{var t;Ct.debug(`Checking page url: ${window.location.href}`);const e=At.get().environmentState.data.actionClasses.filter((t=>{var e;return"noCode"===t.type&&"pageView"===(null==(e=t.noCodeConfig)?void 0:e.type)}));for(const n of e){const e=(null==(t=n.noCodeConfig)?void 0:t.urlFilters)??[];if(!q(e))continue;const r=await lt(n.name);if(!0!==r.ok)return c(r.error)}return{ok:!0,value:void 0}},Lt=()=>Tt(),$t=()=>{"undefined"!=typeof window&&Ut&&(Ot.forEach((t=>window.removeEventListener(t,Lt))),Ut=!1)};let Ft=!1;const Ht=t=>{const{environmentState:e}=At.get();if(!e)return;const{actionClasses:n=[]}=e.data,r=n.filter((t=>{var e;return"noCode"===t.type&&"click"===(null==(e=t.noCodeConfig)?void 0:e.type)})),i=t.target;r.forEach((t=>{((t,e)=>{var n;if("click"!==(null==(n=e.noCodeConfig)?void 0:n.type))return!1;const r=e.noCodeConfig.elementSelector.innerHtml,i=e.noCodeConfig.elementSelector.cssSelector,o=e.noCodeConfig.urlFilters;if(!r&&!i)return!1;if(r&&t.innerHTML!==r)return!1;if(i){const e=i.split(/\s*(?=[.#])/);for(let n of e)if(!t.matches(n))return!1}return!!q(o)})(i,t)&&lt(t.name).then((t=>{var e,n,r;n=t=>{},r=t=>Rt.handle(t),!0===(e=t).ok?n(e.value):r(e.error)}))}))},xt=t=>Ht(t),Pt=()=>{Ft&&(document.removeEventListener("click",xt),Ft=!1)};let Dt=!1;const Nt=t=>(async t=>{var e;const{environmentState:n}=At.get(),{actionClasses:r=[]}=n.data??{},i=r.filter((t=>{var e;return"noCode"===t.type&&"exitIntent"===(null==(e=t.noCodeConfig)?void 0:e.type)}));if(t.clientY<=0&&i.length>0)for(const o of i){const t=(null==(e=o.noCodeConfig)?void 0:e.urlFilters)??[];if(!q(t))continue;const n=await lt(o.name);if(!0!==n.ok)return c(n.error)}})(t),_t=()=>{Dt&&(document.removeEventListener("mouseleave",Nt),Dt=!1)};let Mt=!1,jt=!1;const zt=()=>(async()=>{var t;const e=window.scrollY,n=window.innerHeight,r=document.documentElement.scrollHeight;if(0===e&&(jt=!1),!jt&&e/(r-n)>=.5){jt=!0;const{environmentState:e}=At.get(),{actionClasses:n=[]}=e.data??{},r=n.filter((t=>{var e;return"noCode"===t.type&&"fiftyPercentScroll"===(null==(e=t.noCodeConfig)?void 0:e.type)}));for(const i of r){const e=(null==(t=i.noCodeConfig)?void 0:t.urlFilters)??[];if(!q(e))continue;const n=await lt(i.name);if(!0!==n.ok)return c(n.error)}}return{ok:!0,value:void 0}})(),qt=()=>{Mt&&(window.removeEventListener("scroll",zt),Mt=!1)};let Jt=!1;const Yt=()=>{"undefined"!=typeof window&&null===Et&&(Et=window.setInterval((async()=>{const t=It.get().environmentState.expiresAt;try{if(t&&new Date(t)>=new Date)return;St.debug("Environment State has expired. Starting sync.");const e=It.get().personState,n=await kt({apiHost:It.get().apiHost,environmentId:It.get().environmentId},!0),r=X(n,e);It.update({...It.get(),environmentState:n,filteredSurveys:r})}catch(e){console.error(`Error during expiry check: ${e}`),St.debug("Extending config and try again later.");const t=It.get();It.update(t)}}),6e4)),"undefined"!=typeof window&&null===ht&&(ht=window.setInterval((async()=>{ft.get().personState.data.userId&&ft.update({...ft.get(),personState:{...ft.get().personState,expiresAt:new Date((new Date).getTime()+18e5)}})}),6e4)),"undefined"==typeof window||Ut||(Ot.forEach((t=>window.addEventListener(t,Lt))),Ut=!0),"undefined"==typeof window||Ft||(document.addEventListener("click",xt),Ft=!0),"undefined"==typeof document||Dt||(document.querySelector("body").addEventListener("mouseleave",Nt),Dt=!0),"undefined"==typeof window||Mt||("complete"===document.readyState?window.addEventListener("scroll",zt):window.addEventListener("load",(()=>{window.addEventListener("scroll",zt)})),Mt=!0)},Xt=()=>{Bt(),yt(),$t(),Pt(),_t(),qt(),Jt&&(window.removeEventListener("beforeunload",(()=>{Bt(),yt(),$t(),Pt(),_t(),qt()})),Jt=!1)},Gt=a.getInstance();let Wt=!1;const Vt=t=>{Wt=t},Qt=async t=>{var e,n;const o=Y();o&&Gt.configure({logLevel:"debug"});let s=g.getInstance();const{changed:a,newState:l}=(()=>{const t=localStorage.getItem(r),e=localStorage.getItem(i);if(t){localStorage.removeItem(r);const e=JSON.parse(t);if(e.environmentId&&e.apiHost&&e.environmentState&&e.personState&&e.filteredSurveys)return{changed:!0,newState:{...e}}}if(e){localStorage.removeItem(i);const t=JSON.parse(e);if(t.environmentId&&t.apiHost&&t.environmentState&&t.personState&&t.filteredSurveys)return{changed:!0}}return{changed:!1}})();if(a&&(s.resetConfig(),s=g.getInstance(),!t.userId&&l&&s.update(l)),Wt)return Gt.debug("Already initialized, skipping initialization."),{ok:!0,value:void 0};let f;try{f=s.get(),Gt.debug("Found existing configuration.")}catch(p){Gt.debug("No existing configuration found.")}if("error"===(null==(e=null==f?void 0:f.status)?void 0:e.value)){if(o)return Gt.debug("Formbricks is in error state, but debug mode is active. Resetting config and continuing."),s.resetConfig(),{ok:!0,value:void 0};Gt.debug("Formbricks was set to an error state.");const t=null==(n=null==f?void 0:f.status)?void 0:n.expiresAt;if(t&&new Date(t)>new Date)return Gt.debug("Error state is not expired, skipping initialization"),{ok:!0,value:void 0};Gt.debug("Error state is expired. Continue with initialization.")}if(h.getInstance().printStatus(),Gt.debug("Start initialize"),!t.environmentId)return Gt.debug("No environmentId provided"),c({code:"missing_field",field:"environmentId"});if(!t.apiHost)return Gt.debug("No apiHost provided"),c({code:"missing_field",field:"apiHost"});Gt.debug("Adding widget container to DOM"),rt();let d=null;if(t.attributes)if(t.userId){const e=await(async(t,e,n,r)=>{var i;const o={...r};try{const t=wt.get().personState.data.attributes;if(t)for(const[e,n]of Object.entries(t))o[e]===n&&delete o[e]}catch(p){mt.debug("config not set; sending all attributes to backend")}if(0===Object.keys(o).length)return mt.debug("No attributes to update. Skipping update."),u(o);mt.debug("Updating attributes: "+JSON.stringify(o));const s=new P({apiHost:t,environmentId:e}),a=await s.client.attribute.update({userId:n,attributes:o});return a.ok?u(o):(null==(i=a.error.details)?void 0:i.ignore)?(mt.error(a.error.message??`Error updating person with userId ${n}`),u(o)):c({code:"network_error",status:500,message:`Error updating person with userId ${n}`,url:`${t}/api/v1/client/${e}/people/${n}/attributes`,responseMessage:a.error.message})})(t.apiHost,t.environmentId,t.userId,t.attributes);if(!0!==e.ok)return c(e.error);d=e.value}else d={...t.attributes};if(f&&f.environmentState&&f.environmentId===t.environmentId&&f.apiHost===t.apiHost){Gt.debug("Configuration fits init parameters.");let e=!1,n=!1;new Date(f.environmentState.expiresAt)<new Date&&(Gt.debug("Environment state expired. Syncing."),e=!0),t.userId&&f.personState.expiresAt&&new Date(f.personState.expiresAt)<new Date&&(Gt.debug("Person state expired. Syncing."),n=!0);try{const r=e?await kt({apiHost:t.apiHost,environmentId:t.environmentId}):f.environmentState;let{personState:i}=f;n&&(i=t.userId?await gt({apiHost:t.apiHost,environmentId:t.environmentId,userId:t.userId}):pt);const o=X(r,i);s.update({...f,environmentState:r,personState:i,filteredSurveys:o});const a=o.map((t=>t.name));Gt.debug("Fetched "+a.length+" surveys during sync: "+a.join(", "))}catch(p){te(s)}}else{Gt.debug("No valid configuration found or it has been expired. Resetting config and creating new one."),s.resetConfig(),Gt.debug("Syncing.");try{const e=await kt({apiHost:t.apiHost,environmentId:t.environmentId},!1),n=t.userId?await gt({apiHost:t.apiHost,environmentId:t.environmentId,userId:t.userId},!1):pt,r=X(e,n);s.update({apiHost:t.apiHost,environmentId:t.environmentId,personState:n,environmentState:e,filteredSurveys:r})}catch(p){Zt()}await lt("New Session")}return d&&Object.keys(d).length>0&&s.update({...s.get(),personState:{...s.get().personState,data:{...s.get().personState.data,attributes:{...s.get().personState.data.attributes,...d}}}}),Gt.debug("Adding event listeners"),Yt(),Jt||(window.addEventListener("beforeunload",(()=>{Bt(),yt(),$t(),Pt(),_t(),qt()})),Jt=!0),Vt(!0),Gt.debug("Initialized"),Tt(),{ok:!0,value:void 0}},Zt=()=>{if(Y())return void Gt.debug("Not putting formbricks in error state because debug mode is active (no error state)");const t={status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}};throw l((()=>localStorage.setItem(n,JSON.stringify(t))))(),new Error("Could not initialize formbricks")},Kt=()=>{Gt.debug("Deinitializing"),it(),K(!1),Xt(),Vt(!1)},te=t=>{Y()?Gt.debug("Not putting formbricks in error state because debug mode is active (no error state)"):(Gt.debug("Putting formbricks in error state"),t.update({...t.get(),status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}}),Kt())};const ee=g.getInstance(),ne=a.getInstance(),re=async()=>{Kt(),ee.resetConfig()},ie=async()=>{ne.debug("Resetting state & getting new state from backend"),nt();const t=ee.get().personState.data.userId,e={environmentId:ee.get().environmentId,apiHost:ee.get().apiHost,...t&&{userId:t},attributes:ee.get().personState.data.attributes};await re();try{return await Qt(e),{ok:!0,value:void 0}}catch(n){return c(n)}};a.getInstance().debug("Create command queue");const oe=new class{constructor(){e(this,"queue",[]),e(this,"running",!1),e(this,"resolvePromise",null),e(this,"commandPromise",null)}add(t=!0,e,...n){this.queue.push({command:e,checkInitialized:t,commandArgs:n}),this.running||(this.commandPromise=new Promise((t=>{this.resolvePromise=t,this.run()})))}async wait(){this.running&&await this.commandPromise}async run(){for(this.running=!0;this.queue.length>0;){const t=h.getInstance(),e=this.queue.shift();if(!e)continue;if(e.checkInitialized){const e=(Gt.debug("Check if initialized"),Wt&&h.initialized?{ok:!0,value:void 0}:c({code:"not_initialized",message:"Formbricks not initialized. Call initialize() first."}));if(e&&!0!==e.ok){t.handle(e.error);continue}}const n=async()=>await(null==e?void 0:e.command.apply(null,null==e?void 0:e.commandArgs)),r=await bt(n)();r&&(r.ok&&r.data&&!r.data.ok&&t.handle(r.data.error),!0!==r.ok&&t.handle(r.error))}this.running=!1,this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null,this.commandPromise=null)}},se=async(t,e)=>{oe.add(!0,vt,t,e),await oe.wait()};return{init:async t=>{h.init(t.errorHandler),oe.add(!1,Qt,t),await oe.wait()},setEmail:async t=>{se("email",t),await oe.wait()},setAttribute:se,track:async(t,e)=>{oe.add(!0,ct,t,e),await oe.wait()},logout:async()=>{oe.add(!0,re),await oe.wait()},reset:async()=>{oe.add(!0,ie),await oe.wait()},registerRouteChange:async()=>{oe.add(!0,Tt),await oe.wait()},getApi:()=>{const t=g.getInstance(),{environmentId:e,apiHost:n}=t.get();if(!e||!n)throw new Error("formbricks.init() must be called before getApi()");return new P({apiHost:n,environmentId:e})}}}();
//# sourceMappingURL=index.iife.js.map
