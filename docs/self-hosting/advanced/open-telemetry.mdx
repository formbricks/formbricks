---
title: OpenTelemetry Setup
icon: chart-line
---

This document explains how to set up and use OpenTelemetry in the Formbricks project.

## Overview

OpenTelemetry is an observability framework that provides tools for generating, collecting, and exporting telemetry data (metrics, logs, and traces) to help you analyze your software's performance and behavior.

## Current Setup

Formbricks uses the `@vercel/otel` package to set up OpenTelemetry. The configuration is in the `instrumentation.ts` file in the web app.

## Configuration Options

### 1. Generic OTLP Exporter

You can also use any OpenTelemetry backend that supports the OTLP protocol. To enable this, set the following environment variables:

```
OTEL_EXPORTER_OTLP_ENDPOINT=your_otlp_endpoint
OTEL_SERVICE_NAME=formbricks-web (optional, defaults to "formbricks-web")
OTEL_EXPORTER_OTLP_HEADERS={"header1":"value1","header2":"value2"} (optional)
```

### 2. Prometheus Metrics Exporter

Formbricks can expose metrics in Prometheus format. To enable this, set the following environment variables:

```
PROMETHEUS_ENABLED=1
PROMETHEUS_EXPORTER_PORT=9464 (optional, defaults to 9464)
```

Once enabled, metrics will be available at `http://localhost:9464/metrics`.

#### Setting up Prometheus Server

1. Install Prometheus: [Download Prometheus](https://prometheus.io/download/)

2. Use the provided `prometheus.yml` configuration file in the `apps/web` directory:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "formbricks"
    scrape_interval: 5s
    static_configs:
      - targets: ["localhost:9464"]
    metrics_path: /metrics
```

3. Start Prometheus with this configuration:

```bash
prometheus --config.file=prometheus.yml
```

4. Access the Prometheus UI at `http://localhost:9090`

#### Using Docker

You can also run Prometheus in a Docker container:

```bash
docker run -d -p 9090:9090 -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
```

#### Available Metrics

The following metrics are available:

- `http_requests_total`: Counter for total number of HTTP requests
- `http_request_duration_seconds`: Histogram for HTTP request duration

## Adding Custom Instrumentation

To add custom instrumentation to your code, use the OpenTelemetry API:

```typescript
import { trace } from "@opentelemetry/api";

// Create a tracer
const tracer = trace.getTracer("formbricks-component-name");

// Create a span
const span = tracer.startSpan("operation-name");

try {
  // Your code here

  // Add attributes to the span
  span.setAttribute("attribute.key", "attribute.value");

  // Add events to the span
  span.addEvent("event.name", { "event.key": "event.value" });
} catch (error) {
  // Record errors
  span.recordException(error);
  span.setStatus({ code: SpanStatusCode.ERROR });
} finally {
  // End the span
  span.end();
}
```

### Recording Metrics

To record metrics in your code:

```typescript
// Access the global metrics
const metrics = (global as any).__FORMBRICKS_METRICS;

// Record a counter
metrics.requestCounter.add(1, { endpoint: "/api/example" });

// Record a histogram
metrics.requestDuration.record(0.5, { endpoint: "/api/example" });
```

## Supported OpenTelemetry Backends

You can use any OpenTelemetry backend that supports the OTLP protocol, including:

1. Langfuse (currently configured)
2. Jaeger
3. Zipkin
4. Datadog
5. New Relic
6. Honeycomb
7. Grafana Tempo
8. AWS X-Ray (with OpenTelemetry Collector)
9. Google Cloud Trace (with OpenTelemetry Collector)
10. Azure Monitor (with OpenTelemetry Collector)
11. Prometheus (for metrics)

## Troubleshooting

If you're not seeing traces in your backend:

1. Check that the environment variables are correctly set
2. Verify that your backend is properly configured to receive OTLP data
3. Check for any errors in the console related to OpenTelemetry

If you're not seeing metrics in Prometheus:

1. Ensure `PROMETHEUS_ENABLED=true` is set
2. Check that the Prometheus server is running and configured to scrape from the correct endpoint
3. Verify that the metrics endpoint is accessible at `http://localhost:9464/metrics`

## Resources

- [OpenTelemetry Documentation](https://opentelemetry.io/docs/)
- [Vercel OpenTelemetry Documentation](https://vercel.com/docs/observability/otel-overview)
- [Next.js Instrumentation Documentation](https://nextjs.org/docs/app/building-your-application/optimizing/instrumentation)
- [Prometheus Documentation](https://prometheus.io/docs/introduction/overview/)
